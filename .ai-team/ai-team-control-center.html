<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 Virtual Office Control Center - SPA Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout */
        .control-center {
            display: grid;
            grid-template-rows: 60px 1fr;
            height: 100vh;
        }

        /* System Control Bar */
        .system-control-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(90deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: auto;
        }

        .system-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-start {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(90deg, #f44336, #da190b);
            color: white;
        }

        .btn-restart {
            background: linear-gradient(90deg, #2196F3, #1976D2);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .system-status {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 0 15px;
            border-left: 1px solid #ddd;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online { background: #4CAF50; }
        .status-offline { background: #f44336; }
        .status-pending { background: #FFC107; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 60px);
        }

        /* CEO Dashboard Panel */
        .ceo-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(90deg, #9C27B0, #7B1FA2);
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .ceo-actions {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ceo-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #f5f5f5;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ceo-btn:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .ceo-btn .icon {
            font-size: 20px;
        }

        /* Chat Area */
        .chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px;
        }

        .channel-tabs {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .channel-tab {
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .channel-tab.active {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom: none;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-author {
            font-weight: 600;
            color: #333;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            color: #666;
            line-height: 1.5;
        }

        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .send-btn {
            padding: 10px 20px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Agents Panel */
        .agents-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .agents-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .agent-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ddd;
            transition: all 0.3s;
        }

        .agent-card.online {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }

        .agent-card.busy {
            border-left-color: #FFC107;
            background: #fff8e1;
        }

        .agent-card.offline {
            border-left-color: #f44336;
            background: #ffebee;
            opacity: 0.7;
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .agent-name {
            font-weight: 600;
            font-size: 14px;
        }

        .agent-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
        }

        .agent-task {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Metrics Dashboard */
        .metrics-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .metric-card {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .metric-label {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        /* Knowledge Base Quick Access */
        .knowledge-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
        }

        .knowledge-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .knowledge-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .knowledge-btn:hover {
            background: #f5f5f5;
            border-color: #667eea;
        }

        /* Modal for task creation */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-btn-primary {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
        }

        .modal-btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="control-center">
        <!-- System Control Bar -->
        <div class="system-control-bar">
            <div class="logo">🎯 Virtual Office Control Center</div>

            <div class="system-controls">
                <button class="control-btn btn-start" onclick="startVirtualOffice()">
                    🚀 Start System
                </button>
                <button class="control-btn btn-stop" onclick="stopVirtualOffice()">
                    🛑 Stop System
                </button>
                <button class="control-btn btn-restart" onclick="restartSystem()">
                    🔄 Restart
                </button>
            </div>

            <div class="system-status">
                <div class="status-item">
                    <div class="status-indicator status-offline" id="serverStatus"></div>
                    <span>Server</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-offline" id="agentsStatus"></div>
                    <span id="agentsCount">0/5 Agents</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-online" id="knowledgeStatus"></div>
                    <span>Knowledge Base</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- CEO Dashboard -->
            <div class="left-panel">
                <div class="ceo-panel">
                    <div class="panel-header">👔 CEO Dashboard</div>
                    <div class="ceo-actions">
                        <button class="ceo-btn" onclick="dailyStandup()">
                            <span class="icon">📅</span>
                            <span>Daily Standup</span>
                        </button>
                        <button class="ceo-btn" onclick="createTask()">
                            <span class="icon">📝</span>
                            <span>Create Task</span>
                        </button>
                        <button class="ceo-btn" onclick="assignUrgentTask()">
                            <span class="icon">🚨</span>
                            <span>Urgent Task</span>
                        </button>
                        <button class="ceo-btn" onclick="requestReport()">
                            <span class="icon">📊</span>
                            <span>Request Report</span>
                        </button>
                        <button class="ceo-btn" onclick="emergencyMeeting()">
                            <span class="icon">🔴</span>
                            <span>Emergency Meeting</span>
                        </button>
                        <button class="ceo-btn" onclick="reviewProgress()">
                            <span class="icon">📈</span>
                            <span>Review Progress</span>
                        </button>
                    </div>
                </div>

                <div class="metrics-section">
                    <div class="panel-header" style="background: linear-gradient(90deg, #4CAF50, #45a049); margin: -15px -15px 0 -15px; border-radius: 12px 12px 0 0;">
                        📊 Today's Metrics
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="tasksCompleted">0</div>
                            <div class="metric-label">Completed</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="tasksInProgress">0</div>
                            <div class="metric-label">In Progress</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="tasksBlocked">0</div>
                            <div class="metric-label">Blocked</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="teamEfficiency">0%</div>
                            <div class="metric-label">Efficiency</div>
                        </div>
                    </div>
                </div>

                <div class="knowledge-panel">
                    <div class="panel-header" style="background: linear-gradient(90deg, #FF9800, #F57C00); margin: -15px -15px 0 -15px; border-radius: 12px 12px 0 0;">
                        📚 Knowledge Base
                    </div>
                    <div class="knowledge-buttons">
                        <button class="knowledge-btn" onclick="openKnowledgeMap()">
                            📍 Knowledge Map
                        </button>
                        <button class="knowledge-btn" onclick="searchLessons()">
                            🎓 Search Lessons
                        </button>
                        <button class="knowledge-btn" onclick="viewProblems()">
                            ⚠️ Known Issues
                        </button>
                        <button class="knowledge-btn" onclick="applyPattern()">
                            🔧 Apply Pattern
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-container">
                <div class="chat-header">
                    <div style="font-weight: bold; font-size: 18px;">💬 Team Communication</div>
                    <div class="channel-tabs">
                        <button class="channel-tab active" onclick="switchChannel('general')">
                            #general
                        </button>
                        <button class="channel-tab" onclick="switchChannel('tasks')">
                            #tasks
                        </button>
                        <button class="channel-tab" onclick="switchChannel('standup')">
                            #standup
                        </button>
                        <button class="channel-tab" onclick="switchChannel('reports')">
                            #reports
                        </button>
                        <button class="channel-tab" onclick="switchChannel('alerts')">
                            #alerts
                        </button>
                        <button class="channel-tab" onclick="switchChannel('help')">
                            #help
                        </button>
                    </div>
                </div>

                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be loaded here -->
                    <div class="message">
                        <div class="message-header">
                            <span class="message-author">System</span>
                            <span class="message-time">Just now</span>
                        </div>
                        <div class="message-content">
                            Welcome to Virtual Office Control Center! Use the controls above to start the system.
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput"
                           placeholder="Type a message or command (use / for commands)..."
                           onkeypress="handleChatKeypress(event)">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <!-- Agents Status Panel -->
            <div class="agents-panel">
                <div class="panel-header">🤖 AI Agents Status</div>
                <div class="agents-list" id="agentsList">
                    <div class="agent-card offline">
                        <div class="agent-header">
                            <span class="agent-name">👔 TeamLead</span>
                            <span class="agent-status">Offline</span>
                        </div>
                        <div class="agent-task">Waiting for system start...</div>
                    </div>

                    <div class="agent-card offline">
                        <div class="agent-header">
                            <span class="agent-name">⚙️ Backend</span>
                            <span class="agent-status">Offline</span>
                        </div>
                        <div class="agent-task">Laravel DDD Expert</div>
                    </div>

                    <div class="agent-card offline">
                        <div class="agent-header">
                            <span class="agent-name">🎨 Frontend</span>
                            <span class="agent-status">Offline</span>
                        </div>
                        <div class="agent-task">Vue 3 FSD Specialist</div>
                    </div>

                    <div class="agent-card offline">
                        <div class="agent-header">
                            <span class="agent-name">🔍 QA</span>
                            <span class="agent-status">Offline</span>
                        </div>
                        <div class="agent-task">Testing Expert</div>
                    </div>

                    <div class="agent-card offline">
                        <div class="agent-header">
                            <span class="agent-name">🚢 DevOps</span>
                            <span class="agent-status">Offline</span>
                        </div>
                        <div class="agent-task">Infrastructure</div>
                    </div>
                </div>

                <div class="metrics-section">
                    <div class="panel-header" style="background: linear-gradient(90deg, #2196F3, #1976D2); margin: -15px -15px 0 -15px;">
                        ⏱️ Session Info
                    </div>
                    <div style="padding: 10px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="sessionTimer">00:00:00</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Session Duration</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">📝 Create New Task</div>

            <div class="form-group">
                <label class="form-label">Task Title</label>
                <input type="text" class="form-input" id="taskTitle" placeholder="Enter task title...">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="taskDescription" placeholder="Describe the task in detail..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Assign To</label>
                <select class="form-select" id="taskAssignee">
                    <option value="teamlead">TeamLead</option>
                    <option value="backend">Backend Developer</option>
                    <option value="frontend">Frontend Developer</option>
                    <option value="qa">QA Engineer</option>
                    <option value="devops">DevOps Engineer</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-select" id="taskPriority">
                    <option value="low">Low</option>
                    <option value="normal" selected>Normal</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeTaskModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="submitTask()">Create Task</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentChannel = 'general';
        let systemRunning = false;
        let sessionStartTime = null;
        let agentsOnline = 0;
        let messages = {};
        let tasks = [];

        // Initialize channels
        const channels = ['general', 'tasks', 'standup', 'reports', 'alerts', 'help'];
        channels.forEach(channel => {
            messages[channel] = [];
        });

        // System Control Functions
        async function startVirtualOffice() {
            addMessage('system', '🚀 Starting Virtual Office system...');

            try {
                // Create a PowerShell script to start the system
                const startCommand = `
                    cd C:\\www.spa.com\\.ai-team
                    Start-Process cmd -ArgumentList "/c START-ENHANCED-OFFICE-FIXED.bat" -WindowStyle Normal
                `;

                // Try to execute via different methods
                await executeCommand(startCommand);

                systemRunning = true;
                sessionStartTime = new Date();
                updateSystemStatus('online');

                // Start monitoring
                startMonitoring();

                addMessage('system', '✅ Virtual Office system started successfully!');

                // Simulate agents coming online
                setTimeout(() => updateAgentStatus('teamlead', 'online'), 2000);
                setTimeout(() => updateAgentStatus('backend', 'online'), 3000);
                setTimeout(() => updateAgentStatus('frontend', 'online'), 3500);
                setTimeout(() => updateAgentStatus('qa', 'online'), 4000);
                setTimeout(() => updateAgentStatus('devops', 'online'), 4500);

            } catch (error) {
                addMessage('system', `❌ Failed to start system: ${error.message}`);
                showManualStartInstructions();
            }
        }

        function stopVirtualOffice() {
            if (!systemRunning) {
                addMessage('system', '⚠️ System is not running');
                return;
            }

            addMessage('system', '🛑 Stopping Virtual Office system...');

            // Stop all agents
            ['teamlead', 'backend', 'frontend', 'qa', 'devops'].forEach(agent => {
                updateAgentStatus(agent, 'offline');
            });

            systemRunning = false;
            updateSystemStatus('offline');
            stopMonitoring();

            addMessage('system', '✅ Virtual Office system stopped');
        }

        function restartSystem() {
            if (systemRunning) {
                stopVirtualOffice();
                setTimeout(() => startVirtualOffice(), 2000);
            } else {
                startVirtualOffice();
            }
        }

        // CEO Dashboard Functions
        function dailyStandup() {
            switchChannel('standup');
            addMessage('ceo', '📅 Starting daily standup meeting...');

            // Request status from all agents
            const agents = ['teamlead', 'backend', 'frontend', 'qa', 'devops'];
            agents.forEach(agent => {
                sendToAgent(agent, {
                    type: 'standup_request',
                    message: 'Please provide your daily status update'
                });
            });

            addMessage('system', 'Standup requests sent to all agents');
        }

        function createTask() {
            document.getElementById('taskModal').style.display = 'flex';
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
        }

        function submitTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const assignee = document.getElementById('taskAssignee').value;
            const priority = document.getElementById('taskPriority').value;

            if (!title || !description) {
                alert('Please fill in all required fields');
                return;
            }

            const task = {
                id: `TASK-${Date.now()}`,
                title,
                description,
                assignee,
                priority,
                status: 'new',
                timestamp: new Date().toISOString()
            };

            tasks.push(task);
            sendToAgent(assignee, task);

            switchChannel('tasks');
            addMessage('ceo', `📝 New task created: ${title} (assigned to ${assignee})`);

            closeTaskModal();

            // Clear form
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
        }

        function assignUrgentTask() {
            const task = prompt('Enter urgent task description:');
            if (task) {
                switchChannel('alerts');
                addMessage('ceo', `🚨 URGENT TASK: ${task}`);

                // Send to TeamLead for immediate action
                sendToAgent('teamlead', {
                    type: 'urgent_task',
                    message: task,
                    priority: 'urgent'
                });
            }
        }

        function requestReport() {
            switchChannel('reports');
            addMessage('ceo', '📊 Requesting status report from all teams...');

            sendToAgent('teamlead', {
                type: 'report_request',
                message: 'Please provide current project status report'
            });
        }

        function emergencyMeeting() {
            switchChannel('alerts');
            addMessage('ceo', '🔴 EMERGENCY MEETING - All agents required immediately!');

            // Notify all agents
            const agents = ['teamlead', 'backend', 'frontend', 'qa', 'devops'];
            agents.forEach(agent => {
                sendToAgent(agent, {
                    type: 'emergency',
                    message: 'Emergency meeting called by CEO'
                });
            });
        }

        function reviewProgress() {
            const completed = tasks.filter(t => t.status === 'completed').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const blocked = tasks.filter(t => t.status === 'blocked').length;

            updateMetrics(completed, inProgress, blocked);

            addMessage('system', `📈 Progress Review: ${completed} completed, ${inProgress} in progress, ${blocked} blocked`);
        }

        // Chat Functions
        function switchChannel(channel) {
            currentChannel = channel;

            // Update tab styles
            document.querySelectorAll('.channel-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.includes(channel)) {
                    tab.classList.add('active');
                }
            });

            // Load messages for channel
            loadChannelMessages(channel);
        }

        function loadChannelMessages(channel) {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';

            const channelMessages = messages[channel] || [];
            channelMessages.forEach(msg => {
                displayMessage(msg);
            });

            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function addMessage(author, content) {
            const message = {
                author,
                content,
                timestamp: new Date().toLocaleTimeString(),
                channel: currentChannel
            };

            messages[currentChannel].push(message);
            displayMessage(message);
        }

        function displayMessage(message) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // Author colors
            const authorColors = {
                'system': '#607D8B',
                'ceo': '#9C27B0',
                'teamlead': '#E91E63',
                'backend': '#4CAF50',
                'frontend': '#2196F3',
                'qa': '#FF9800',
                'devops': '#795548'
            };

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-author" style="color: ${authorColors[message.author] || '#333'}">
                        ${message.author.toUpperCase()}
                    </span>
                    <span class="message-time">${message.timestamp}</span>
                </div>
                <div class="message-content">${message.content}</div>
            `;

            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Check for commands
            if (message.startsWith('/')) {
                handleCommand(message);
            } else {
                addMessage('ceo', message);

                // If in tasks channel, create a task
                if (currentChannel === 'tasks' && message.length > 10) {
                    const quickTask = {
                        type: 'quick_task',
                        message: message
                    };
                    sendToAgent('teamlead', quickTask);
                }
            }

            input.value = '';
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleCommand(command) {
            const cmd = command.toLowerCase();

            const commands = {
                '/help': () => {
                    addMessage('system', `Available commands:
                        /start - Start Virtual Office
                        /stop - Stop Virtual Office
                        /status - Check system status
                        /agents - List agent status
                        /tasks - Show active tasks
                        /clear - Clear current channel`);
                },
                '/start': () => startVirtualOffice(),
                '/stop': () => stopVirtualOffice(),
                '/status': () => checkSystemStatus(),
                '/agents': () => listAgents(),
                '/tasks': () => listTasks(),
                '/clear': () => clearChannel()
            };

            const handler = commands[cmd];
            if (handler) {
                handler();
            } else {
                addMessage('system', `Unknown command: ${command}. Type /help for available commands.`);
            }
        }

        // Agent Communication
        function sendToAgent(agent, data) {
            // Create JSON file in agent's inbox
            const fileName = `task_${Date.now()}.json`;
            const filePath = `virtual-office/inbox/${agent}/${fileName}`;

            // Simulate sending (in real implementation, this would write to file system)
            console.log(`Sending to ${agent}:`, data);

            // Simulate response after delay
            setTimeout(() => {
                simulateAgentResponse(agent, data);
            }, 3000 + Math.random() * 2000);
        }

        function simulateAgentResponse(agent, originalTask) {
            const responses = {
                'teamlead': 'Task received. Analyzing and assigning to team...',
                'backend': 'Working on backend implementation...',
                'frontend': 'Creating UI components...',
                'qa': 'Preparing test cases...',
                'devops': 'Setting up infrastructure...'
            };

            addMessage(agent, responses[agent] || 'Task acknowledged');

            // Update agent status
            updateAgentStatus(agent, 'busy', `Working on: ${originalTask.title || originalTask.message}`);
        }

        // System Monitoring
        function startMonitoring() {
            // Update session timer
            setInterval(updateSessionTimer, 1000);

            // Check agent status
            setInterval(checkAgentsStatus, 5000);

            // Update metrics
            setInterval(updateMetrics, 10000);
        }

        function stopMonitoring() {
            // Clear all intervals (simplified - in production, store interval IDs)
        }

        function updateSessionTimer() {
            if (!sessionStartTime) return;

            const now = new Date();
            const diff = now - sessionStartTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);

            document.getElementById('sessionTimer').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkAgentsStatus() {
            // In real implementation, check actual agent processes
            // For now, simulate random status changes
            if (systemRunning && Math.random() > 0.8) {
                const agents = ['teamlead', 'backend', 'frontend', 'qa', 'devops'];
                const randomAgent = agents[Math.floor(Math.random() * agents.length)];
                const statuses = ['online', 'busy'];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];

                updateAgentStatus(randomAgent, randomStatus);
            }
        }

        function updateAgentStatus(agent, status, task = null) {
            const agentCards = document.querySelectorAll('.agent-card');

            agentCards.forEach(card => {
                if (card.querySelector('.agent-name').textContent.toLowerCase().includes(agent)) {
                    // Update card class
                    card.className = `agent-card ${status}`;

                    // Update status text
                    const statusText = card.querySelector('.agent-status');
                    statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);

                    // Update task if provided
                    if (task) {
                        card.querySelector('.agent-task').textContent = task;
                    }
                }
            });

            // Update global agent count
            const onlineAgents = document.querySelectorAll('.agent-card.online, .agent-card.busy').length;
            document.getElementById('agentsCount').textContent = `${onlineAgents}/5 Agents`;

            // Update status indicator
            const agentsIndicator = document.getElementById('agentsStatus');
            if (onlineAgents === 0) {
                agentsIndicator.className = 'status-indicator status-offline';
            } else if (onlineAgents < 5) {
                agentsIndicator.className = 'status-indicator status-pending';
            } else {
                agentsIndicator.className = 'status-indicator status-online';
            }
        }

        function updateSystemStatus(status) {
            const serverIndicator = document.getElementById('serverStatus');
            serverIndicator.className = `status-indicator status-${status}`;
        }

        function updateMetrics(completed = 0, inProgress = 0, blocked = 0) {
            document.getElementById('tasksCompleted').textContent = completed;
            document.getElementById('tasksInProgress').textContent = inProgress;
            document.getElementById('tasksBlocked').textContent = blocked;

            const total = completed + inProgress + blocked;
            const efficiency = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('teamEfficiency').textContent = `${efficiency}%`;
        }

        // Knowledge Base Functions
        function openKnowledgeMap() {
            addMessage('system', '📚 Opening Knowledge Map...');
            window.open('virtual-office/knowledge/KNOWLEDGE_MAP.md', '_blank');
        }

        function searchLessons() {
            const query = prompt('What lesson are you looking for?');
            if (query) {
                addMessage('system', `🔍 Searching lessons for: ${query}`);
                // In real implementation, search through lesson files
            }
        }

        function viewProblems() {
            addMessage('system', '⚠️ Loading known problems index...');
            window.open('virtual-office/knowledge/problems/INDEX.md', '_blank');
        }

        function applyPattern() {
            const patterns = [
                'Business Logic First',
                'KISS Principle',
                'Watcher Chain Pattern',
                'FSD Architecture'
            ];

            const pattern = prompt(`Select pattern to apply:\n${patterns.map((p, i) => `${i+1}. ${p}`).join('\n')}`);
            if (pattern) {
                addMessage('system', `🔧 Applying pattern: ${patterns[parseInt(pattern) - 1] || pattern}`);
            }
        }

        // Utility Functions
        async function executeCommand(command) {
            // Try to execute command via different methods
            // This is a simplified version - real implementation would need proper backend

            try {
                // Method 1: Try via fetch to local endpoint
                const response = await fetch('http://localhost:8082/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command})
                });

                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.log('Direct execution failed, showing manual instructions');
            }

            return null;
        }

        function showManualStartInstructions() {
            const instructions = `
To start Virtual Office manually:
1. Open Command Prompt or PowerShell
2. Navigate to: C:\\www.spa.com\\.ai-team
3. Run: START-ENHANCED-OFFICE-FIXED.bat
4. Wait for all agents to start
5. Refresh this page`;

            alert(instructions);
            addMessage('system', 'Manual start instructions displayed');
        }

        function checkSystemStatus() {
            const status = systemRunning ? '🟢 Online' : '🔴 Offline';
            const agents = document.querySelectorAll('.agent-card.online, .agent-card.busy').length;

            addMessage('system', `System Status: ${status}, Active Agents: ${agents}/5`);
        }

        function listAgents() {
            const agentStatuses = [];
            document.querySelectorAll('.agent-card').forEach(card => {
                const name = card.querySelector('.agent-name').textContent;
                const status = card.querySelector('.agent-status').textContent;
                agentStatuses.push(`${name}: ${status}`);
            });

            addMessage('system', 'Agent Status:\n' + agentStatuses.join('\n'));
        }

        function listTasks() {
            if (tasks.length === 0) {
                addMessage('system', 'No active tasks');
                return;
            }

            const taskList = tasks.map(t =>
                `${t.id}: ${t.title} (${t.assignee}) - ${t.status}`
            ).join('\n');

            addMessage('system', 'Active Tasks:\n' + taskList);
        }

        function clearChannel() {
            messages[currentChannel] = [];
            loadChannelMessages(currentChannel);
            addMessage('system', 'Channel cleared');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Add welcome message
            addMessage('system', 'Welcome to Virtual Office Control Center!');
            addMessage('system', 'Type /help for available commands or use the buttons above to control the system.');

            // Check if system is already running
            setTimeout(() => {
                fetch('http://localhost:8082/status')
                    .then(response => {
                        if (response.ok) {
                            systemRunning = true;
                            updateSystemStatus('online');
                            addMessage('system', '✅ AI Team Server detected - system is running');
                            startMonitoring();
                        }
                    })
                    .catch(() => {
                        addMessage('system', '⚠️ AI Team Server not detected. Click "Start System" to begin.');
                    });
            }, 1000);
        });
    </script>
</body>
</html>