<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –º–∞—Å—Ç–µ—Ä–∞</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        select, input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #007bff;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background: #e6f3ff;
        }
        .upload-icon {
            font-size: 48px;
            color: #999;
            margin-bottom: 16px;
        }
        .upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .upload-hint {
            color: #999;
            font-size: 14px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-item .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .progress {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
            width: 0%;
        }
        .master-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .master-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .master-info p {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –º–∞—Å—Ç–µ—Ä–∞</h1>
        
        <div class="form-group">
            <label for="master_select">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞:</label>
            <select id="master_select">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞...</option>
                <option value="1">–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞ (anna-1)</option>
                <option value="2">–ú–∏—Ö–∞–∏–ª –ò–≤–∞–Ω–æ–≤ (mihail-2)</option>
                <option value="3">–ï–ª–µ–Ω–∞ –°–∏–¥–æ—Ä–æ–≤–∞ (elena-3)</option>
                <option value="4">–î–º–∏—Ç—Ä–∏–π –ö–æ–∑–ª–æ–≤ (dmitriy-4)</option>
                <option value="5">–û–ª—å–≥–∞ –°–º–∏—Ä–Ω–æ–≤–∞ (olga-5)</option>
                <option value="7">–ê–Ω–Ω–∞ –í–æ–ª–∫–æ–≤–∞ (anna-7)</option>
                <option value="9">–ê–Ω–Ω–∞ –ú–æ—Ä–æ–∑–æ–≤–∞ (anna-9)</option>
                <option value="10">–ê–Ω–Ω–∞ –ù–æ–≤–∏–∫–æ–≤–∞ (anna-10)</option>
                <option value="11">–ê–Ω–Ω–∞ –§–µ–¥–æ—Ä–æ–≤–∞ (anna-11)</option>
                <option value="12">–ê–Ω–Ω–∞ –ú–∏—Ö–∞–π–ª–æ–≤–∞ (anna-12)</option>
                <option value="13">–ê–Ω–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∞ (anna-13)</option>
                <option value="14">–ê–Ω–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–∞ (anna-14)</option>
                <option value="15">–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ (mariya-15)</option>
                <option value="16">–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞ (mariya-16)</option>
                <option value="17">–ï–ª–µ–Ω–∞ –ö–æ–∑–ª–æ–≤–∞ (elena-17)</option>
                <option value="18">–ï–ª–µ–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞ (elena-18)</option>
                <option value="19">–û–ª—å–≥–∞ –í–æ–ª–∫–æ–≤–∞ (olga-19)</option>
                <option value="20">–û–ª—å–≥–∞ –ú–æ—Ä–æ–∑–æ–≤–∞ (olga-20)</option>
                <option value="21">–ù–∞—Ç–∞–ª—å—è (natalya-21)</option>
                <option value="22">–ù–∞—Ç–∞–ª—å—è –§–µ–¥–æ—Ä–æ–≤–∞ (natalya-22)</option>
            </select>
        </div>

        <div id="master_info" class="master-info" style="display: none;">
            <h3 id="master_name"></h3>
            <p><strong>–ü–∞–ø–∫–∞:</strong> <span id="master_folder"></span></p>
            <p><strong>–¢–µ–∫—É—â–∏—Ö —Ñ–æ—Ç–æ:</strong> <span id="current_photos">0</span></p>
        </div>

        <div class="upload-area" id="upload_area">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
            <div class="upload-hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, WEBP (–º–∞–∫—Å. 10MB –∫–∞–∂–¥—ã–π)</div>
            <input type="file" id="file_input" multiple accept="image/*" style="display: none;">
        </div>

        <div id="preview" class="preview"></div>

        <div class="progress" id="progress">
            <div class="progress-bar" id="progress_bar"></div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" id="upload_btn" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</button>
        </div>

        <div id="result" class="result"></div>
    </div>

    <script>
        const masterSelect = document.getElementById('master_select');
        const masterInfo = document.getElementById('master_info');
        const masterName = document.getElementById('master_name');
        const masterFolder = document.getElementById('master_folder');
        const currentPhotos = document.getElementById('current_photos');
        const uploadArea = document.getElementById('upload_area');
        const fileInput = document.getElementById('file_input');
        const preview = document.getElementById('preview');
        const uploadBtn = document.getElementById('upload_btn');
        const result = document.getElementById('result');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progress_bar');

        let selectedFiles = [];
        let currentMaster = null;

        // –î–∞–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–æ–≤
        const masters = {
            1: { name: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞', folder: 'anna-1' },
            2: { name: '–ú–∏—Ö–∞–∏–ª –ò–≤–∞–Ω–æ–≤', folder: 'mihail-2' },
            3: { name: '–ï–ª–µ–Ω–∞ –°–∏–¥–æ—Ä–æ–≤–∞', folder: 'elena-3' },
            4: { name: '–î–º–∏—Ç—Ä–∏–π –ö–æ–∑–ª–æ–≤', folder: 'dmitriy-4' },
            5: { name: '–û–ª—å–≥–∞ –°–º–∏—Ä–Ω–æ–≤–∞', folder: 'olga-5' },
            7: { name: '–ê–Ω–Ω–∞ –í–æ–ª–∫–æ–≤–∞', folder: 'anna-7' },
            9: { name: '–ê–Ω–Ω–∞ –ú–æ—Ä–æ–∑–æ–≤–∞', folder: 'anna-9' },
            10: { name: '–ê–Ω–Ω–∞ –ù–æ–≤–∏–∫–æ–≤–∞', folder: 'anna-10' },
            11: { name: '–ê–Ω–Ω–∞ –§–µ–¥–æ—Ä–æ–≤–∞', folder: 'anna-11' },
            12: { name: '–ê–Ω–Ω–∞ –ú–∏—Ö–∞–π–ª–æ–≤–∞', folder: 'anna-12' },
            13: { name: '–ê–Ω–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∞', folder: 'anna-13' },
            14: { name: '–ê–Ω–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–∞', folder: 'anna-14' },
            15: { name: '–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞', folder: 'mariya-15' },
            16: { name: '–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞', folder: 'mariya-16' },
            17: { name: '–ï–ª–µ–Ω–∞ –ö–æ–∑–ª–æ–≤–∞', folder: 'elena-17' },
            18: { name: '–ï–ª–µ–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞', folder: 'elena-18' },
            19: { name: '–û–ª—å–≥–∞ –í–æ–ª–∫–æ–≤–∞', folder: 'olga-19' },
            20: { name: '–û–ª—å–≥–∞ –ú–æ—Ä–æ–∑–æ–≤–∞', folder: 'olga-20' },
            21: { name: '–ù–∞—Ç–∞–ª—å—è', folder: 'natalya-21' },
            22: { name: '–ù–∞—Ç–∞–ª—å—è –§–µ–¥–æ—Ä–æ–≤–∞', folder: 'natalya-22' }
        };

        // –í—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞
        masterSelect.addEventListener('change', async function() {
            const masterId = this.value;
            if (!masterId) {
                masterInfo.style.display = 'none';
                currentMaster = null;
                updateUploadButton();
                return;
            }

            currentMaster = masters[masterId];
            masterName.textContent = currentMaster.name;
            masterFolder.textContent = currentMaster.folder;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–∏—Ö —Ñ–æ—Ç–æ
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/masters/${masterId}/photos`);
                const data = await response.json();
                currentPhotos.textContent = data.count || 0;
            } catch (error) {
                currentPhotos.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
            
            masterInfo.style.display = 'block';
            updateUploadButton();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => {
                if (!file.type.startsWith('image/')) {
                    showResult('–§–∞–π–ª ' + file.name + ' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º', 'error');
                    return false;
                }
                if (file.size > 10 * 1024 * 1024) {
                    showResult('–§–∞–π–ª ' + file.name + ' —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10MB)', 'error');
                    return false;
                }
                return true;
            });

            updatePreview();
            updateUploadButton();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
        function updatePreview() {
            preview.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <button class="remove" onclick="removeFile(${index})">√ó</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –ø—Ä–µ–≤—å—é
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
            updateUploadButton();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        function updateUploadButton() {
            uploadBtn.disabled = !currentMaster || selectedFiles.length === 0;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
        uploadBtn.addEventListener('click', async () => {
            if (!currentMaster || selectedFiles.length === 0) return;

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('photos[]', file);
            });

            uploadBtn.disabled = true;
            progress.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                const response = await fetch(`http://127.0.0.1:8000/masters/${masterSelect.value}/upload/photos/test`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRF-TOKEN': await getCSRFToken()
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showResult(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${data.photos.length} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π!`, 'success');
                    selectedFiles = [];
                    preview.innerHTML = '';
                    fileInput.value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ
                    currentPhotos.textContent = parseInt(currentPhotos.textContent) + data.photos.length;
                } else {
                    showResult('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                showResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                progress.style.display = 'none';
                updateUploadButton();
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(message, type) {
            result.textContent = message;
            result.className = `result ${type}`;
            result.style.display = 'block';
            setTimeout(() => {
                result.style.display = 'none';
            }, 5000);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
        async function getCSRFToken() {
            try {
                const response = await fetch('http://127.0.0.1:8000/');
                const text = await response.text();
                const match = text.match(/name="csrf-token" content="([^"]+)"/);
                return match ? match[1] : '';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞:', error);
                return '';
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        window.removeFile = removeFile;
    </script>
</body>
</html> 