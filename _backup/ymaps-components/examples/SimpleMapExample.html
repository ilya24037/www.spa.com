<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä Yandex Maps –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .map-container {
            width: 100%;
            height: 500px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        .info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        
        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #6c757d;
            font-size: 14px;
            font-weight: normal;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
        }
        
        .log {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f5;
            font-size: 14px;
            color: #495057;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .log-item .time {
            color: #868e96;
            margin-right: 10px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 500px;
            color: #6c757d;
            font-size: 18px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Yandex Maps –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</h1>
        
        <div class="info">
            <h3>üìñ –û–ø–∏—Å–∞–Ω–∏–µ</h3>
            <p>–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ Yandex Maps –±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤.</p>
            <p>–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–¥—É–ª–∏: YMapsCore, Placemark, Balloon, Clusterer, MapBehaviors</p>
        </div>
        
        <div class="controls">
            <button onclick="addMarkers(10)">–î–æ–±–∞–≤–∏—Ç—å 10 –º–µ—Ç–æ–∫</button>
            <button onclick="addMarkers(50)">–î–æ–±–∞–≤–∏—Ç—å 50 –º–µ—Ç–æ–∫</button>
            <button onclick="clearMarkers()" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <button onclick="toggleClustering()" class="success">–í–∫–ª/–í—ã–∫–ª –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é</button>
            <button onclick="toggleDragging()">–í–∫–ª/–í—ã–∫–ª –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</button>
            <button onclick="showBalloon()">–ü–æ–∫–∞–∑–∞—Ç—å Balloon</button>
            <button onclick="centerMap()">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="fitAllMarkers()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏</button>
        </div>
        
        <div id="map" class="map-container">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h4>–í—Å–µ–≥–æ –º–µ—Ç–æ–∫</h4>
                <div class="value" id="marker-count">0</div>
            </div>
            <div class="stat-card">
                <h4>–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è</h4>
                <div class="value" id="clustering-status">–í—ã–∫–ª</div>
            </div>
            <div class="stat-card">
                <h4>–¢–µ–∫—É—â–∏–π –∑—É–º</h4>
                <div class="value" id="current-zoom">10</div>
            </div>
            <div class="stat-card">
                <h4>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</h4>
                <div class="value" id="drag-status">–í–∫–ª</div>
            </div>
        </div>
        
        <h3>üìä –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h3>
        <div class="log" id="event-log">
            <div class="log-item">
                <span class="time">--:--:--</span>
                –°–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ -->
    <script type="module">
        import YMapsCore from '../core/YMapsCore.js'
        import MapBehaviors from '../behaviors/MapBehaviors.js'
        import Placemark from '../modules/Placemark/Placemark.js'
        import Balloon from '../modules/Balloon/Balloon.js'
        import Clusterer from '../modules/Clusterer/Clusterer.js'
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map = null
        let mapsCore = null
        let behaviors = null
        let clusterer = null
        let balloon = null
        let markers = []
        let useClusterin
g = false
        let isDraggingEnabled = true
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        async function initMap() {
            try {
                logEvent('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...')
                
                // –°–æ–∑–¥–∞–µ–º —è–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã
                mapsCore = new YMapsCore({
                    apiKey: '', // –£–∫–∞–∂–∏—Ç–µ –≤–∞—à API –∫–ª—é—á
                    lang: 'ru_RU',
                    coordorder: 'latlong'
                })
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º API
                await mapsCore.loadAPI()
                logEvent('API –∑–∞–≥—Ä—É–∂–µ–Ω')
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
                const mapContainer = document.getElementById('map')
                mapContainer.innerHTML = '' // –û—á–∏—â–∞–µ–º loading
                
                map = await mapsCore.createMap('map', {
                    center: [55.753994, 37.622093],
                    zoom: 10,
                    controls: ['zoomControl', 'fullscreenControl']
                })
                
                logEvent('–ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞')
                
                // –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–≤–µ–¥–µ–Ω–∏–π
                behaviors = new MapBehaviors(map, {
                    drag: true,
                    dblClickZoom: true,
                    scrollZoom: true,
                    multiTouch: true
                })
                
                logEvent('–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–≤–µ–¥–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω')
                
                // –°–æ–∑–¥–∞–µ–º balloon
                balloon = new Balloon(map, {
                    closeButton: true,
                    autoPan: true,
                    maxWidth: 300
                })
                
                // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫–∞—Ä—Ç—ã
                map.events.add('boundschange', (e) => {
                    const zoom = Math.round(e.get('newZoom'))
                    document.getElementById('current-zoom').textContent = zoom
                })
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏
                addMarkers(5)
                
                logEvent('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã: ' + error.message)
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫
        window.addMarkers = function(count) {
            const center = map.getCenter()
            const newMarkers = []
            
            for (let i = 0; i < count; i++) {
                const lat = center[0] + (Math.random() - 0.5) * 0.2
                const lng = center[1] + (Math.random() - 0.5) * 0.2
                
                const placemark = new Placemark(
                    [lat, lng],
                    {
                        balloonContent: `
                            <div style="padding: 10px;">
                                <h4>–ú–µ—Ç–∫–∞ ${markers.length + i + 1}</h4>
                                <p>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                            </div>
                        `,
                        hintContent: `–ú–µ—Ç–∫–∞ ${markers.length + i + 1}`
                    },
                    {
                        preset: 'islands#blueIcon',
                        draggable: false
                    }
                )
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                placemark.on('click', (e) => {
                    logEvent(`–ö–ª–∏–∫ –ø–æ –º–µ—Ç–∫–µ ${markers.length + i + 1}`)
                })
                
                newMarkers.push(placemark)
            }
            
            if (useClustering && clusterer) {
                clusterer.add(newMarkers)
            } else {
                newMarkers.forEach(pm => pm.addToMap(map))
            }
            
            markers.push(...newMarkers)
            updateMarkerCount()
            logEvent(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${count} –º–µ—Ç–æ–∫`)
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –º–µ—Ç–æ–∫
        window.clearMarkers = function() {
            if (clusterer) {
                clusterer.removeAll()
            } else {
                markers.forEach(pm => pm.removeFromMap())
            }
            
            markers = []
            updateMarkerCount()
            logEvent('–í—Å–µ –º–µ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω—ã')
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
        window.toggleClustering = function() {
            useClustering = !useClustering
            
            if (useClustering) {
                // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä
                if (!clusterer) {
                    clusterer = new Clusterer(map, {
                        preset: 'islands#blueClusterIcons',
                        gridSize: 60,
                        minClusterSize: 2
                    })
                }
                
                // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏ —Å –∫–∞—Ä—Ç—ã
                markers.forEach(pm => pm.removeFromMap())
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä
                clusterer.add(markers)
                
            } else {
                // –£–¥–∞–ª—è–µ–º –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä–∞
                if (clusterer) {
                    clusterer.removeAll()
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
                markers.forEach(pm => pm.addToMap(map))
            }
            
            document.getElementById('clustering-status').textContent = useClustering ? '–í–∫–ª' : '–í—ã–∫–ª'
            logEvent(`–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è ${useClustering ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–æ—Ç–∫–ª—é—á–µ–Ω–∞'}`)
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        window.toggleDragging = function() {
            isDraggingEnabled = !isDraggingEnabled
            
            if (isDraggingEnabled) {
                behaviors.enableDrag()
            } else {
                behaviors.disableDrag()
            }
            
            document.getElementById('drag-status').textContent = isDraggingEnabled ? '–í–∫–ª' : '–í—ã–∫–ª'
            logEvent(`–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ ${isDraggingEnabled ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–æ—Ç–∫–ª—é—á–µ–Ω–æ'}`)
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å balloon
        window.showBalloon = async function() {
            const center = map.getCenter()
            
            await balloon.open(
                center,
                `
                    <div style="padding: 15px;">
                        <h3 style="margin-top: 0;">üéà –ü—Ä–∏–º–µ—Ä Balloon</h3>
                        <p>–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Balloon</p>
                        <p><strong>–¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã:</strong><br>
                        ${center[0].toFixed(4)}, ${center[1].toFixed(4)}</p>
                        <p><strong>–¢–µ–∫—É—â–∏–π –∑—É–º:</strong> ${map.getZoom()}</p>
                        <button onclick="balloon.close()" style="
                            padding: 5px 10px;
                            background: #007bff;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `
            )
            
            logEvent('Balloon –æ—Ç–∫—Ä—ã—Ç')
        }
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É
        window.centerMap = function() {
            map.setCenter([55.753994, 37.622093], 10, {
                duration: 500
            })
            logEvent('–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞')
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏
        window.fitAllMarkers = function() {
            if (markers.length === 0) {
                logEvent('–ù–µ—Ç –º–µ—Ç–æ–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞')
                return
            }
            
            if (useClustering && clusterer) {
                clusterer.fitToViewport()
            } else {
                // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                const bounds = markers.reduce((acc, marker) => {
                    const pos = marker.getPosition()
                    if (!acc) {
                        return [[pos[0], pos[1]], [pos[0], pos[1]]]
                    }
                    return [
                        [Math.min(acc[0][0], pos[0]), Math.min(acc[0][1], pos[1])],
                        [Math.max(acc[1][0], pos[0]), Math.max(acc[1][1], pos[1])]
                    ]
                }, null)
                
                if (bounds) {
                    map.setBounds(bounds, {
                        checkZoomRange: true,
                        zoomMargin: 50
                    })
                }
            }
            
            logEvent('–ö–∞—Ä—Ç–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –º–µ—Ç–∫–∞–º')
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –º–µ—Ç–æ–∫
        function updateMarkerCount() {
            document.getElementById('marker-count').textContent = markers.length
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
        function logEvent(message) {
            const time = new Date().toLocaleTimeString('ru-RU')
            const logContainer = document.getElementById('event-log')
            
            const logItem = document.createElement('div')
            logItem.className = 'log-item'
            logItem.innerHTML = `<span class="time">${time}</span>${message}`
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
            if (logContainer.firstChild) {
                logContainer.insertBefore(logItem, logContainer.firstChild)
            } else {
                logContainer.innerHTML = ''
                logContainer.appendChild(logItem)
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild)
            }
        }
        
        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const container = document.querySelector('.container')
            const errorDiv = document.createElement('div')
            errorDiv.className = 'error'
            errorDiv.textContent = message
            container.insertBefore(errorDiv, container.firstChild)
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initMap)
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏
        window.mapComponents = {
            map,
            mapsCore,
            behaviors,
            clusterer,
            balloon,
            markers
        }
    </script>
</body>
</html>