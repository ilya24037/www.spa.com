<?php
// Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ² MySQL Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
$host = 'localhost';
$db = 'laravel_auth';
$user = 'root';
$pass = 'Animatori2025!';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$db;charset=utf8mb4", $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    echo "âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ‘Ğ” ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾\n\n";
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
    echo "ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ²:\n";
    $vars = ['sort_buffer_size', 'read_rnd_buffer_size', 'join_buffer_size'];
    foreach ($vars as $var) {
        $stmt = $pdo->query("SHOW VARIABLES LIKE '$var'");
        $result = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($result) {
            $mb = round($result['Value'] / 1024 / 1024, 2);
            echo "  {$result['Variable_name']}: {$result['Value']} ({$mb} MB)\n";
        }
    }
    
    echo "\nğŸ”§ Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±ÑƒÑ„ĞµÑ€Ñ‹...\n";
    
    // Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±ÑƒÑ„ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑĞµÑÑĞ¸Ğ¸ (Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² SUPER)
    $commands = [
        "SET SESSION sort_buffer_size = 8388608",      // 8MB
        "SET SESSION read_rnd_buffer_size = 4194304",   // 4MB
        "SET SESSION join_buffer_size = 4194304"        // 4MB
    ];
    
    foreach ($commands as $cmd) {
        try {
            $pdo->exec($cmd);
            echo "  âœ… $cmd\n";
        } catch (Exception $e) {
            echo "  âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ: $cmd\n";
        }
    }
    
    // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² SUPER)
    echo "\nğŸ”§ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸...\n";
    $globalCommands = [
        "SET GLOBAL sort_buffer_size = 8388608",
        "SET GLOBAL read_rnd_buffer_size = 4194304",
        "SET GLOBAL join_buffer_size = 4194304"
    ];
    
    foreach ($globalCommands as $cmd) {
        try {
            $pdo->exec($cmd);
            echo "  âœ… $cmd\n";
        } catch (Exception $e) {
            echo "  âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ: $cmd\n";
        }
    }
    
    // ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ ads
    echo "\nğŸ”§ ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ ads...\n";
    try {
        $pdo->exec("OPTIMIZE TABLE ads");
        echo "  âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ads Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°\n";
    } catch (Exception $e) {
        echo "  âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ\n";
    }
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
    echo "\nğŸ”§ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ğ½Ğ´ĞµĞºÑĞ¾Ğ²...\n";
    $stmt = $pdo->query("SHOW INDEX FROM ads WHERE Key_name = 'idx_user_status_created'");
    if ($stmt->rowCount() == 0) {
        try {
            $pdo->exec("CREATE INDEX idx_user_status_created ON ads (user_id, status, created_at DESC)");
            echo "  âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ¸Ğ½Ğ´ĞµĞºÑ idx_user_status_created\n";
        } catch (Exception $e) {
            echo "  âš ï¸ Ğ˜Ğ½Ğ´ĞµĞºÑ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½\n";
        }
    } else {
        echo "  âœ… Ğ˜Ğ½Ğ´ĞµĞºÑ idx_user_status_created ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚\n";
    }
    
    echo "\nâœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!\n";
    echo "\nğŸ“ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:\n";
    echo "1. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² my.ini (Ğ¸Ğ»Ğ¸ my.cnf):\n";
    echo "   [mysqld]\n";
    echo "   sort_buffer_size = 8M\n";
    echo "   read_rnd_buffer_size = 4M\n";
    echo "   join_buffer_size = 4M\n";
    echo "2. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ MySQL ÑĞµÑ€Ğ²Ğ¸Ñ\n";
    
} catch (PDOException $e) {
    echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ‘Ğ”: " . $e->getMessage() . "\n";
}