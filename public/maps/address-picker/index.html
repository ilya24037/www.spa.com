<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</title>
    
    <!-- Yandex Maps API -->
    <script 
        src="https://api-maps.yandex.ru/2.1/?apikey=23ff8acc-835f-4e99-8b19-d33c5d346e18&lang=ru_RU"
        onerror="console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Yandex Maps API'); showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');"
        onload="console.log('‚úÖ [AddressPicker] Yandex Maps API –∑–∞–≥—Ä—É–∂–µ–Ω')"
    ></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #addressSearch {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
        }
        
        #addressSearch:focus {
            border-color: #007bff;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            min-height: 400px;
            background: #f0f0f0;
        }
        
        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 500;
            width: 30px;
            height: 30px;
            background: #ff4444;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .center-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff4444;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
            max-width: 80%;
        }
        
        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #007bff;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input 
            type="text" 
            id="addressSearch" 
            placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞..."
            autocomplete="off"
        >
    </div>
    
    <div id="map"></div>
    
    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã -->
    <div class="center-marker"></div>
    
    <script>
        let myMap;
        let geocoder;
        let moveTimeout;
        let isGeocoding = false;
        let isProgrammaticMove = false;
        let mapInitialized = false;
        let apiLoadAttempts = 0;
        const maxApiLoadAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
        
        console.log('üó∫Ô∏è [AddressPicker] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
        console.log('üîß [AddressPicker] window.parent exists:', !!window.parent);
        console.log('üîß [AddressPicker] Current URL:', window.location.href);
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(message) {
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            // –£–±–∏—Ä–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 10000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoading(message) {
            const existingLoading = document.querySelector('.loading-message');
            if (existingLoading) {
                existingLoading.remove();
            }
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message';
            loadingDiv.textContent = message;
            document.body.appendChild(loadingDiv);
            
            return loadingDiv;
        }
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ Yandex Maps API
        function waitForYandexMaps() {
            apiLoadAttempts++;
            
            if (typeof ymaps === 'undefined') {
                if (apiLoadAttempts === 1) {
                    showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...');
                }
                
                if (apiLoadAttempts >= maxApiLoadAttempts) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ API –∫–ª—é—á.');
                    return;
                }
                
                console.log('‚è≥ [AddressPicker] –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ API... –ø–æ–ø—ã—Ç–∫–∞', apiLoadAttempts);
                setTimeout(waitForYandexMaps, 100);
                return;
            }
            
            console.log('‚úÖ [AddressPicker] API –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º...');
            
            // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            const loadingDiv = document.querySelector('.loading-message');
            if (loadingDiv) {
                loadingDiv.remove();
            }
            
            try {
                ymaps.ready(init);
            } catch (error) {
                console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ ymaps.ready:', error);
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã: ' + error.message);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            console.log('üìÑ [AddressPicker] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            if (typeof ymaps === 'undefined') {
                console.log('‚è≥ [AddressPicker] API –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∂–¥–µ–º...');
                waitForYandexMaps();
            } else {
                console.log('‚úÖ [AddressPicker] API —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                ymaps.ready(init);
            }
        });
        
        function init() {
            console.log('üöÄ [AddressPicker] –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...');
            console.log('üîß [AddressPicker] –≠–ª–µ–º–µ–Ω—Ç #map:', document.getElementById('map'));
            console.log('üîß [AddressPicker] –†–∞–∑–º–µ—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–∞ #map:', {
                width: document.getElementById('map').offsetWidth,
                height: document.getElementById('map').offsetHeight,
                clientWidth: document.getElementById('map').clientWidth,
                clientHeight: document.getElementById('map').clientHeight
            });
            
            try {
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ –ú–æ—Å–∫–≤–µ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
                myMap = new ymaps.Map('map', {
                    center: [55.7558, 37.6176], // –ú–æ—Å–∫–≤–∞
                    zoom: 12
                }, {
                    suppressMapOpenBlock: true,
                    yandexMapDisablePoiInteractivity: true,
                    suppressObsoleteBrowserNotifier: true,
                    suppressMapOpenBlock: true,
                    yandexMapDisablePoiInteractivity: true
                });
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                setTimeout(() => {
                    if (myMap) {
                        try {
                            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                            myMap.setCenter([55.7558, 37.6176], 12, {
                                checkZoomRange: true
                            });
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã
                            myMap.controls.add('zoomControl', {
                                position: {top: 10, left: 10}
                            });
                            
                            console.log('üîß [AddressPicker] –ö–∞—Ä—Ç–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã');
                        } catch (error) {
                            console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã:', error);
                        }
                    }
                }, 50);
                
                console.log('‚úÖ [AddressPicker] –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ:', !!myMap);
                console.log('üîß [AddressPicker] –†–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã:', {
                    width: myMap.container.getSize()[0],
                    height: myMap.container.getSize()[1]
                });
                
                // –°–æ–∑–¥–∞–µ–º –≥–µ–æ–∫–æ–¥–µ—Ä
                geocoder = ymaps.geocode;
                console.log('‚úÖ [AddressPicker] –ì–µ–æ–∫–æ–¥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω:', !!geocoder);
                
                mapInitialized = true;
                
            } catch (error) {
                console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã: ' + error.message);
                return;
            }
            
            console.log('‚úÖ [AddressPicker] –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã
            setTimeout(() => {
                if (myMap) {
                    try {
                        myMap.container.fitToViewport();
                        console.log('üîß [AddressPicker] –†–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                        
                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                        myMap.setCenter([55.7558, 37.6176], 12, {
                            checkZoomRange: true
                        });
                        
                        console.log('üîß [AddressPicker] –ö–∞—Ä—Ç–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                    } catch (error) {
                        console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã:', error);
                    }
                }
            }, 200);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
            setupSearch();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∞–¥—Ä–µ—Å–∞
            myMap.events.add('actionend', handleMapMove);
            console.log('üéØ [AddressPicker] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ actionend –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∞–¥—Ä–µ—Å–∞');
            
            // –°–æ–æ–±—â–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—é —á—Ç–æ –∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞
            notifyParent('mapReady', { status: 'ready' });
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            const initialCenter = myMap.getCenter();
            setTimeout(() => {
                geocodeCoordinates(initialCenter);
            }, 300);
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('addressSearch');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) return;
                
                searchTimeout = setTimeout(() => {
                    searchAddress(query);
                }, 500);
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();
                    if (query.length >= 3) {
                        searchAddress(query);
                    }
                }
            });
        }
        
        function searchAddress(query) {
            console.log('üîç [AddressPicker] –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞:', query);
            
            if (!geocoder) {
                console.error('‚ùå [AddressPicker] –ì–µ–æ–∫–æ–¥–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            geocoder(query, {
                results: 1,
                boundedBy: myMap.getBounds()
            }).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                
                if (firstGeoObject) {
                    const coords = firstGeoObject.geometry.getCoordinates();
                    const address = firstGeoObject.getAddressLine();
                    
                    console.log('‚úÖ [AddressPicker] –ù–∞–π–¥–µ–Ω –∞–¥—Ä–µ—Å:', address, coords);
                    
                    isProgrammaticMove = true;
                    
                    myMap.setCenter(coords, {
                        checkZoomRange: true
                    });
                    
                    document.getElementById('addressSearch').value = address;
                    
                    notifyParent('addressSelected', {
                        coordinates: coords,
                        address: address,
                        precision: 'search'
                    });
                } else {
                    console.warn('‚ö†Ô∏è [AddressPicker] –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω:', query);
                }
            }).catch(function (error) {
                console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            });
        }
        
        function handleMapMove(e) {
            clearTimeout(moveTimeout);
            
            if (isProgrammaticMove) {
                isProgrammaticMove = false;
                return;
            }
            
            if (isGeocoding) {
                return;
            }
            
            moveTimeout = setTimeout(() => {
                const currentCenter = myMap.getCenter();
                geocodeCoordinates(currentCenter);
            }, 800);
        }
        
        async function geocodeCoordinates(coordinates) {
            isGeocoding = true;
            
            try {
                const result = await geocoder(coordinates, {
                    results: 1,
                    kind: 'house'
                });
                
                const firstGeoObject = result.geoObjects.get(0);
                if (firstGeoObject) {
                    const address = firstGeoObject.getAddressLine();
                    
                    notifyParent('addressSelected', {
                        coordinates: coordinates,
                        address: address,
                        precision: 'house'
                    });
                } else {
                    console.warn('‚ö†Ô∏è [AddressPicker] –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
                    notifyParent('addressSelected', {
                        coordinates: coordinates,
                        address: '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + coordinates[0].toFixed(6) + ', ' + coordinates[1].toFixed(6),
                        precision: 'unknown'
                    });
                }
            } catch (error) {
                console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                
                notifyParent('addressSelected', {
                    coordinates: coordinates,
                    address: '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + coordinates[0].toFixed(6) + ', ' + coordinates[1].toFixed(6),
                    precision: 'error'
                });
            } finally {
                isGeocoding = false;
            }
        }
        
        function notifyParent(type, data) {
            if (window.parent && window.parent !== window) {
                const message = {
                    type: type,
                    data: data,
                    source: 'address-picker',
                    timestamp: Date.now()
                };
                
                try {
                    window.parent.postMessage(message, '*');
                } catch (error) {
                    console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) {
                console.warn('‚ö†Ô∏è [AddressPicker] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ origin:', event.origin);
                return;
            }
            
            const { type, data } = event.data || {};
            console.log('üì® [AddressPicker] –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è:', { type, data });
            
            if (!mapInitialized) {
                console.warn('‚ö†Ô∏è [AddressPicker] –ö–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                return;
            }
            
            switch (type) {
                case 'setMarker':
                    handleSetMarker(data);
                    break;
                    
                case 'searchAddress':
                    handleSearchAddress(data);
                    break;
                    
                case 'clearMarker':
                    handleClearMarker();
                    break;
                    
                default:
                    console.log('ü§∑ [AddressPicker] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞:', type);
            }
        });
        
        function handleSetMarker(data) {
            console.log('üìç [AddressPicker] handleSetMarker –≤—ã–∑–≤–∞–Ω:', data);
            
            if (!data || !data.coordinates) {
                console.error('‚ùå [AddressPicker] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è setMarker:', data);
                return;
            }
            
            const [lat, lng] = data.coordinates;
            
            try {
                isProgrammaticMove = true;
                
                myMap.setCenter([lat, lng], {
                    checkZoomRange: true,
                    duration: 500
                });
                
                console.log('‚úÖ [AddressPicker] –ú–∞—Ä–∫–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
            } catch (error) {
                console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–∞:', error);
            }
        }
        
        function handleSearchAddress(data) {
            if (data && data.query) {
                searchAddress(data.query);
            }
        }
        
        function handleClearMarker() {
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä - —ç—Ç–æ CSS —ç–ª–µ–º–µ–Ω—Ç, –æ–Ω –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–∫–Ω–∞
        window.addEventListener('resize', function() {
            if (myMap && mapInitialized) {
                setTimeout(() => {
                    try {
                        myMap.container.fitToViewport();
                        console.log('üîß [AddressPicker] –†–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ resize');
                    } catch (error) {
                        console.error('‚ùå [AddressPicker] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤:', error);
                    }
                }, 100);
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫—Ä–∞—Ö–∞ –∫–∞—Ä—Ç—ã
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('full.js')) {
                console.warn('‚ö†Ô∏è [AddressPicker] –ü–æ–¥–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ Yandex Maps:', event.message);
                event.preventDefault();
                return false;
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.toString().includes('distance')) {
                console.warn('‚ö†Ô∏è [AddressPicker] –ü–æ–¥–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –ø—Ä–æ–º–∏—Å–∞ Yandex Maps:', event.reason);
                event.preventDefault();
            }
        });
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        setInterval(() => {
            if (myMap && mapInitialized) {
                try {
                    myMap.container.fitToViewport();
                    console.log('üîÑ [AddressPicker] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã');
                } catch (error) {
                    console.warn('‚ö†Ô∏è [AddressPicker] –û—à–∏–±–∫–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                }
            }
        }, 2000);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º waitForYandexMaps() –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ window.addEventListener('load')
    </script>
</body>
</html>