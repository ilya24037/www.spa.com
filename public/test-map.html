<!DOCTYPE html>
<html>
<head>
    <title>üó∫Ô∏è –¢–µ—Å—Ç –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –ö–∞—Ä—Ç—ã</title>
    <meta charset="utf-8">
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .map-container { width: 100%; height: 400px; border: 1px solid #ccc; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.loading { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üó∫Ô∏è –¢–µ—Å—Ç –ú–æ–¥—É–ª—å–Ω–æ–π –ö–∞—Ä—Ç—ã</h1>
        
        <div class="test-section">
            <h3>üìã –®–∞–≥ 1: –ü—Ä—è–º–∞—è –ó–∞–≥—Ä—É–∑–∫–∞ Yandex Maps API</h3>
            <div id="status-api" class="status loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ API...</div>
            <div id="map-direct" class="map-container"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã –®–∞–≥ 2: –ß–µ—Ä–µ–∑ MapLoader.ts</h3>
            <div id="status-loader" class="status loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ MapLoader...</div>
            <div id="map-loader" class="map-container"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã –õ–æ–≥–∏</h3>
            <div id="logs" style="background: #f5f5f5; padding: 10px; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        const API_KEY = '23ff8acc-835f-4e99-8b19-d33c5d346e18';
        const logs = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#c62828' : type === 'success' ? '#2e7d32' : '#666';
            logs.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            console.log(`[MapTest] ${message}`);
        }
        
        // –®–∞–≥ 1: –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ API
        async function testDirectAPI() {
            try {
                log('üöÄ –¢–µ—Å—Ç 1: –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Yandex Maps API');
                
                const script = document.createElement('script');
                script.src = `https://api-maps.yandex.ru/2.1/?apikey=${API_KEY}&lang=ru_RU`;
                script.async = true;
                
                script.onload = () => {
                    log('‚úÖ API –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                    
                    if (window.ymaps && window.ymaps.ready) {
                        window.ymaps.ready(() => {
                            log('‚úÖ ymaps.ready –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                            
                            const map = new window.ymaps.Map('map-direct', {
                                center: [58.0105, 56.2502], // –ü–µ—Ä–º—å
                                zoom: 14,
                                controls: ['zoomControl']
                            });
                            
                            document.getElementById('status-api').innerHTML = '‚úÖ –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: –£–°–ü–ï–•';
                            document.getElementById('status-api').className = 'status success';
                            log('‚úÖ –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–µ API', 'success');
                        });
                    } else {
                        throw new Error('window.ymaps –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    }
                };
                
                script.onerror = () => {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ API');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ 1: ${error.message}`, 'error');
                document.getElementById('status-api').innerHTML = '‚ùå –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: –û–®–ò–ë–ö–ê';
                document.getElementById('status-api').className = 'status error';
            }
        }
        
        // –®–∞–≥ 2: –ß–µ—Ä–µ–∑ MapLoader (—ç–º—É–ª—è—Ü–∏—è)
        async function testMapLoader() {
            try {
                log('üöÄ –¢–µ—Å—Ç 2: –ß–µ—Ä–µ–∑ —ç–º—É–ª—è—Ü–∏—é MapLoader');
                
                // –≠–º—É–ª–∏—Ä—É–µ–º MapLoader –ª–æ–≥–∏–∫—É
                class TestMapLoader {
                    constructor() {
                        this.loadPromise = null;
                        this.isLoaded = false;
                    }
                    
                    async load(apiKey) {
                        if (this.isLoaded && window.ymaps) {
                            return window.ymaps;
                        }
                        
                        if (this.loadPromise) {
                            return this.loadPromise;
                        }
                        
                        this.loadPromise = this.loadScript(apiKey);
                        const ymaps = await this.loadPromise;
                        this.isLoaded = true;
                        return ymaps;
                    }
                    
                    loadScript(apiKey) {
                        return new Promise((resolve, reject) => {
                            if (window.ymaps?.ready) {
                                window.ymaps.ready(() => resolve(window.ymaps));
                                return;
                            }
                            
                            const script = document.createElement('script');
                            const apiKeyParam = apiKey ? `apikey=${apiKey}&` : '';
                            script.src = `https://api-maps.yandex.ru/2.1/?${apiKeyParam}lang=ru_RU`;
                            script.async = true;
                            
                            script.onload = () => {
                                window.ymaps.ready(() => resolve(window.ymaps));
                            };
                            
                            script.onerror = () => {
                                this.loadPromise = null;
                                reject(new Error('Failed to load Yandex Maps API'));
                            };
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
                            const existingScript = document.querySelector(`script[src*="api-maps.yandex.ru"]`);
                            if (!existingScript) {
                                document.head.appendChild(script);
                            } else {
                                // –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º ymaps
                                if (window.ymaps?.ready) {
                                    window.ymaps.ready(() => resolve(window.ymaps));
                                } else {
                                    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
                                    setTimeout(() => {
                                        if (window.ymaps?.ready) {
                                            window.ymaps.ready(() => resolve(window.ymaps));
                                        } else {
                                            reject(new Error('ymaps –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è'));
                                        }
                                    }, 2000);
                                }
                            }
                        });
                    }
                }
                
                const loader = new TestMapLoader();
                const ymaps = await loader.load(API_KEY);
                
                log('‚úÖ MapLoader –∑–∞–≥—Ä—É–∑–∏–ª API —É—Å–ø–µ—à–Ω–æ', 'success');
                
                const map = new ymaps.Map('map-loader', {
                    center: [58.0105, 56.2502],
                    zoom: 14,
                    controls: ['zoomControl', 'typeSelector']
                });
                
                document.getElementById('status-loader').innerHTML = '‚úÖ MapLoader: –£–°–ü–ï–•';
                document.getElementById('status-loader').className = 'status success';
                log('‚úÖ –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ MapLoader', 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ 2: ${error.message}`, 'error');
                document.getElementById('status-loader').innerHTML = '‚ùå MapLoader: –û–®–ò–ë–ö–ê';
                document.getElementById('status-loader').className = 'status error';
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        log('üèÅ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã');
        
        // –¢–µ—Å—Ç 1 —Å—Ä–∞–∑—É
        testDirectAPI();
        
        // –¢–µ—Å—Ç 2 —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(testMapLoader, 3000);
    </script>
</body>
</html>