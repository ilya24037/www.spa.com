<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–ò–ù–ê–õ–¨–ù–´–ô —Ç–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .test-block { border: 2px solid #007bff; padding: 20px; margin: 15px 0; border-radius: 8px; background: white; }
        .success { background-color: #d4edda; border-color: #28a745; }
        .error { background-color: #f8d7da; border-color: #dc3545; }
        .warning { background-color: #fff3cd; border-color: #ffc107; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 4px; font-size: 16px; }
        .btn-test { background-color: #28a745; color: white; }
        .btn-check { background-color: #17a2b8; color: white; }
        .btn-clear { background-color: #6c757d; color: white; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1 style="color: #007bff;">üîß –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</h1>
    
    <div class="test-block" style="background: #e7f3ff;">
        <h2>üéØ –¶–ï–õ–¨ –¢–ï–°–¢–ê</h2>
        <p><strong>–ü–†–û–ë–õ–ï–ú–ê:</strong> –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ –≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ</p>
        <p><strong>–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:</strong> Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ FormData</p>
        <p><strong>–û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:</strong> "üîÑ –ë—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω: –î–ê" + —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</p>
    </div>

    <div class="test-block">
        <h3>üß™ –¢–µ—Å—Ç–æ–≤–∞—è —Ñ–æ—Ä–º–∞</h3>
        
        <div class="form-group">
            <label for="testAdId">ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</label>
            <input type="number" id="testAdId" value="5" placeholder="ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞">
            <small style="color: #666;">–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —á–µ—Ä–Ω–æ–≤–∏–∫ —Å —ç—Ç–∏–º ID —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î</small>
        </div>
        
        <div class="form-group">
            <label for="testTitle">–ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="testTitle" value="" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è">
        </div>
        
        <div class="form-group">
            <label for="testDescription">–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="testDescription" rows="2" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è"></textarea>
        </div>
        
        <button onclick="testDraftUpdate()" class="btn-test">
            üöÄ –¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
        </button>
        
        <button onclick="checkDraftsCount()" class="btn-check">
            üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
        </button>
        
        <button onclick="clearLog()" class="btn-clear">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
        </button>
    </div>

    <div class="test-block">
        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div id="testLog" class="log">
            –õ–û–ì–ê –ù–ï–¢ - –ù–ê–ß–ù–ò–¢–ï –¢–ï–°–¢<br>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('testLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#333',
                'success': '#28a745', 
                'error': '#dc3545',
                'warning': '#ffc107',
                'debug': '#6c757d'
            };
            
            logElement.innerHTML += `<span style="color: ${colors[type]}; font-weight: bold;">[${timestamp}] ${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '–õ–æ–≥ –æ—á–∏—â–µ–Ω. –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É —Ç–µ—Å—Ç—É...<br>';
        }
        
        async function testDraftUpdate() {
            const adId = document.getElementById('testAdId').value;
            const title = document.getElementById('testTitle').value;
            const description = document.getElementById('testDescription').value;
            
            if (!adId || adId <= 0) {
                log('‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (–±–æ–ª—å—à–µ 0)', 'error');
                return;
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('testTitle').value = `–§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ ${timestamp}`;
            document.getElementById('testDescription').value = `–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ ${new Date().toLocaleString()}`;
            
            log(`üé¨ –°–¢–ê–†–¢ –§–ò–ù–ê–õ–¨–ù–û–ì–û –¢–ï–°–¢–ê`, 'debug');
            log(`üéØ –ß–µ—Ä–Ω–æ–≤–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ID=${adId}`, 'info');
            log(`üìù –ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫: "${document.getElementById('testTitle').value}"`, 'info');
            
            try {
                // –ü–æ–¥—Å—á–∏—Ç–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –î–û –æ–ø–µ—Ä–∞—Ü–∏–∏
                const countBefore = await getDraftsCount();
                log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –î–û –æ–ø–µ—Ä–∞—Ü–∏–∏: ${countBefore}`, 'info');
                
                // –ì–æ—Ç–æ–≤–∏–º FormData
                const formData = new FormData();
                formData.append('ad_id', adId); // –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï!
                formData.append('id', adId); // –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                formData.append('title', document.getElementById('testTitle').value);
                formData.append('description', document.getElementById('testDescription').value);
                formData.append('specialty', '–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç');
                formData.append('phone', '+7 (999) 888-77-66');
                
                log(`‚úÖ FormData –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å ad_id: ${adId}`, 'success');
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ú–ï–ù–¢: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ü–†–ê–í–ò–õ–¨–ù–´–ô –º–∞—Ä—à—Ä—É—Ç
                log(`üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /test-draft (–ë–ï–ó CSRF)...`, 'debug');
                
                const response = await fetch('/test-draft', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const result = await response.json();
                    
                    log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –ü–û–°–õ–ï –æ–ø–µ—Ä–∞—Ü–∏–∏: ${result.total_drafts}`, 'info');
                    log(`üéØ ID —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${result.ad_id}`, 'info');
                    log(`üîÑ –ë—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω: ${result.was_updated ? '–î–ê ‚úÖ' : '–ù–ï–¢ ‚ùå'}`, result.was_updated ? 'success' : 'error');
                    
                    // –û–°–ù–û–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
                    if (result.was_updated && result.ad_id == adId) {
                        log(`üéâ –£–°–ü–ï–•! –ß–µ—Ä–Ω–æ–≤–∏–∫ ID=${adId} –±—ã–ª –û–ë–ù–û–í–õ–ï–ù, –∞ –Ω–µ —Å–æ–∑–¥–∞–Ω –∑–∞–Ω–æ–≤–æ!`, 'success');
                        log(`‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û!`, 'success');
                        
                        if (countBefore == result.total_drafts) {
                            log(`‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ: ${countBefore} = ${result.total_drafts}`, 'success');
                        } else {
                            log(`‚ö†Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: ${countBefore} ‚Üí ${result.total_drafts}`, 'warning');
                        }
                    } else {
                        log(`‚ùå –ü–†–û–í–ê–õ! –ë—ã–ª —Å–æ–∑–¥–∞–Ω –ù–û–í–´–ô —á–µ—Ä–Ω–æ–≤–∏–∫ ID=${result.ad_id} –≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ID=${adId}`, 'error');
                        log(`‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï –†–ê–ë–û–¢–ê–ï–¢!`, 'error');
                        log(`üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ª–∏ ad_id –≤ Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ?`, 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê: ${errorText.substring(0, 200)}...`, 'error');
                }
                
            } catch (error) {
                log(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }
        
        async function getDraftsCount() {
            try {
                const response = await fetch('/api/drafts-count');
                if (response.ok) {
                    const data = await response.json();
                    return data.count;
                } else {
                    log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤`, 'warning');
                    return '?';
                }
            } catch (error) {
                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞: ${error.message}`, 'warning');
                return '?';
            }
        }
        
        async function checkDraftsCount() {
            log('üîç –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∏...', 'debug');
            const count = await getDraftsCount();
            log(`üìä –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –≤ –ë–î: ${count}`, 'info');
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('testTitle').value = `–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç ${timestamp}`;
            document.getElementById('testDescription').value = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ ${new Date().toLocaleString()}`;
            
            log('üöÄ –§–ò–ù–ê–õ–¨–ù–ê–Ø –¢–ï–°–¢–û–í–ê–Ø –°–¢–†–ê–ù–ò–¶–ê –ó–ê–ì–†–£–ñ–ï–ù–ê', 'success');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏', 'info');
            log('üéØ –û–∂–∏–¥–∞–µ—Ç—Å—è: "üîÑ –ë—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω: –î–ê ‚úÖ"', 'debug');
        };
    </script>
</body>
</html>