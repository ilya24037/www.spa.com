<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ú–ù–´–ô –¢–ï–°–¢ - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; padding: 30px; }
        .test-block { border: 2px solid #007bff; padding: 25px; margin: 20px 0; border-radius: 10px; background: #f8f9ff; }
        .success { background-color: #d4edda; border-color: #28a745; }
        .error { background-color: #f8d7da; border-color: #dc3545; }
        .info { background-color: #d1ecf1; border-color: #17a2b8; }
        button { padding: 15px 30px; margin: 10px 0; cursor: pointer; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; }
        .btn-test { background-color: #28a745; color: white; }
        .btn-load { background-color: #17a2b8; color: white; }
        select, input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .log { background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 14px; max-height: 350px; overflow-y: auto; }
        h1 { color: #007bff; text-align: center; }
        h2 { color: #28a745; }
        .draft-list { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß† –£–ú–ù–´–ô –¢–ï–°–¢: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</h1>
    
    <div class="test-block info">
        <h2>üéØ –û —Ç–µ—Å—Ç–µ</h2>
        <p><strong>–¶–ï–õ–¨:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</p>
        <p><strong>–õ–û–ì–ò–ö–ê:</strong> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–µ—Ä–Ω–æ–≤–∏–∫ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</p>
    </div>

    <div class="test-block">
        <h2>üìã 1. –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –∏–∑ –ë–î</h2>
        <button onclick="loadDrafts()" class="btn-load">
            üîç –ù–ê–ô–¢–ò –ß–ï–†–ù–û–í–ò–ö–ò –í –ë–î
        </button>
        
        <div id="draftsInfo" class="draft-list" style="display: none;">
            <strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏:</strong>
            <select id="draftSelect" size="3" style="height: 80px;"></select>
        </div>
    </div>

    <div class="test-block">
        <h2>üß™ 2. –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
        <button onclick="runSmartTest()" class="btn-test" id="testBtn" disabled>
            üöÄ –¢–ï–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (—Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏)
        </button>
        
        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
        <div id="testResult" class="log">
            –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ù–ê–ô–¢–ò –ß–ï–†–ù–û–í–ò–ö–ò –í –ë–î"...
        </div>
    </div>

    <script>
        let availableDrafts = [];
        
        function log(message, isSuccess = null) {
            const result = document.getElementById('testResult');
            const color = isSuccess === true ? '#28a745' : isSuccess === false ? '#dc3545' : '#333';
            result.innerHTML += `<div style="color: ${color}; margin: 5px 0;">${message}</div>`;
            result.scrollTop = result.scrollHeight;
        }

        async function loadDrafts() {
            const testBlocks = document.querySelectorAll('.test-block');
            const firstBlock = testBlocks[1]; // –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            firstBlock.className = 'test-block';
            
            document.getElementById('testResult').innerHTML = '';
            log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –∏–∑ –ë–î...');
            
            try {
                const response = await fetch('/test-drafts-count');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                log(`üìä –ù–∞–π–¥–µ–Ω–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤: ${data.count}`);
                
                if (data.count === 0) {
                    log('‚ùå –í –ë–î –Ω–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!', false);
                    log('üí° –°–æ–∑–¥–∞–π—Ç–µ —á–µ—Ä–Ω–æ–≤–∏–∫ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–ª–∏ Tinker', false);
                    firstBlock.className = 'test-block error';
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º draft
                log('üîÑ –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤...');
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π API)
                availableDrafts = [];
                for (let i = 1; i <= Math.min(data.count, 10); i++) {
                    availableDrafts.push({
                        id: i,
                        title: `–ß–µ—Ä–Ω–æ–≤–∏–∫ ${i}`,
                        exists: true // –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∏ —Ç–µ—Å—Ç–µ
                    });
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç
                const select = document.getElementById('draftSelect');
                select.innerHTML = '';
                availableDrafts.forEach(draft => {
                    const option = document.createElement('option');
                    option.value = draft.id;
                    option.textContent = `ID=${draft.id} - ${draft.title}`;
                    select.appendChild(option);
                });
                
                // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
                if (availableDrafts.length > 0) {
                    select.selectedIndex = 0;
                }
                
                document.getElementById('draftsInfo').style.display = 'block';
                document.getElementById('testBtn').disabled = false;
                document.getElementById('testBtn').textContent = 'üöÄ –¢–ï–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø';
                
                log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${availableDrafts.length} —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è`, true);
                log(`üéØ –í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–Ω–æ–≤–∏–∫ –≤ —Å–ø–∏—Å–∫–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–¢–ï–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø"`);
                
                firstBlock.className = 'test-block success';
                
            } catch (error) {
                log(`üí• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, false);
                firstBlock.className = 'test-block error';
            }
        }

        async function runSmartTest() {
            const testBlocks = document.querySelectorAll('.test-block');
            const testBlock = testBlocks[testBlocks.length - 1];
            if (testBlock) testBlock.className = 'test-block';
            
            const select = document.getElementById('draftSelect');
            const selectedId = select.value;
            
            if (!selectedId) {
                log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–Ω–æ–≤–∏–∫ –∏–∑ —Å–ø–∏—Å–∫–∞!', false);
                return;
            }
            
            document.getElementById('testResult').innerHTML = '';
            log('üé¨ –°–¢–ê–†–¢ –£–ú–ù–û–ì–û –¢–ï–°–¢–ê');
            log(`üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ ID: ${selectedId}`);
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –î–û
                const countResponse = await fetch('/test-drafts-count');
                const countBefore = countResponse.ok ? (await countResponse.json()).count : 0;
                log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –î–û: ${countBefore}`);
                
                // 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const timestamp = new Date().toLocaleTimeString();
                const formData = new FormData();
                formData.append('ad_id', selectedId); // –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï!
                formData.append('id', selectedId);
                formData.append('title', `–£–ú–ù–´–ô –¢–ï–°–¢ ${timestamp}`);
                formData.append('description', `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ ${new Date().toLocaleString()}`);
                formData.append('specialty', '–¢–µ—Å—Ç–æ–≤–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
                formData.append('phone', '+7 (999) 777-88-99');
                
                log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã —Å ad_id: ${selectedId}`);
                
                // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /test-draft-fix...');
                
                const response = await fetch('/test-draft-fix', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –ü–û–°–õ–ï: ${result.total_drafts}`);
                    log(`üéØ ID —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${result.ad_id}`);
                    log(`üîÑ –ë—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω: ${result.was_updated ? '–î–ê' : '–ù–ï–¢'}`);
                    
                    // 4. –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–ê
                    if (result.was_updated && result.ad_id == selectedId) {
                        log(`üéâ –ü–û–õ–ù–´–ô –£–°–ü–ï–•! –ß–µ—Ä–Ω–æ–≤–∏–∫ ID=${selectedId} –±—ã–ª –û–ë–ù–û–í–õ–ï–ù!`, true);
                        log('‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢–ê–ï–¢ –ù–ê 100%!', true);
                        if (testBlock) testBlock.className = 'test-block success';
                        
                        if (countBefore == result.total_drafts) {
                            log(`‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ: ${countBefore} = ${result.total_drafts}`, true);
                        } else {
                            log(`‚ÑπÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: ${countBefore} ‚Üí ${result.total_drafts}`, null);
                        }
                    } else if (result.was_updated === false && result.ad_id != selectedId) {
                        log(`‚ö†Ô∏è –ß–µ—Ä–Ω–æ–≤–∏–∫ ID=${selectedId} –ù–ï –ù–ê–ô–î–ï–ù –≤ –ë–î`, false);
                        log(`üìù –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ ID=${result.ad_id}`, false);
                        log(`üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π ID –∏–∑ —Å–ø–∏—Å–∫–∞`, false);
                        if (testBlock) testBlock.className = 'test-block error';
                    } else {
                        log(`‚ùì –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: was_updated=${result.was_updated}, ad_id=${result.ad_id}`, false);
                        if (testBlock) testBlock.className = 'test-block error';
                    }
                    
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê: ${response.status}`, false);
                    log(`üìÑ ${errorText.substring(0, 150)}...`, false);
                    if (testBlock) testBlock.className = 'test-block error';
                }
                
            } catch (error) {
                log(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, false);
                if (testBlock) testBlock.className = 'test-block error';
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('üß† –£–º–Ω—ã–π —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–ù–ê–ô–¢–ò –ß–ï–†–ù–û–í–ò–ö–ò –í –ë–î" –¥–ª—è –Ω–∞—á–∞–ª–∞');
        };
    </script>
</body>
</html>