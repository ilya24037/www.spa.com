<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .test-block { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</h1>
    
    <div class="test-block info">
        <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ</h3>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ–≥–¥–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ –≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ.</p>
        <p><strong>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫" –¥–æ–ª–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ, –∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –Ω–æ–≤–æ–µ.</p>
    </div>

    <div class="test-block">
        <h3>üéØ –¢–µ—Å—Ç–æ–≤–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞</h3>
        
        <div class="form-group">
            <label for="testAdId">ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
            <input type="number" id="testAdId" value="5" placeholder="ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞">
        </div>
        
        <div class="form-group">
            <label for="testTitle">–ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="testTitle" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫">
        </div>
        
        <div class="form-group">
            <label for="testDescription">–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="testDescription" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        </div>
        
        <button onclick="testDraftSave()" style="background-color: #28a745; color: white; border: none;">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ (—Ç–µ—Å—Ç)
        </button>
        
        <button onclick="checkDraftsCount()" style="background-color: #17a2b8; color: white; border: none;">
            üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
        </button>
        
        <button onclick="clearLog()" style="background-color: #6c757d; color: white; border: none;">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
        </button>
    </div>

    <div class="test-block">
        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div id="testLog" class="log">
            –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...<br>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('testLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#333',
                'success': '#28a745', 
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colors[type]};">[${timestamp}] ${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...<br>';
        }
        
        async function testDraftSave() {
            const adId = document.getElementById('testAdId').value;
            const title = document.getElementById('testTitle').value;
            const description = document.getElementById('testDescription').value;
            
            if (!adId) {
                log('‚ùå –£–∫–∞–∂–∏—Ç–µ ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }
            
            if (!title) {
                document.getElementById('testTitle').value = `–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ${new Date().toLocaleTimeString()}`;
            }
            
            if (!description) {
                document.getElementById('testDescription').value = `–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${new Date().toLocaleString()}`;
            }
            
            log(`üîß –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç —Å —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º ID: ${adId}`, 'info');
            log(`üìù –ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫: "${document.getElementById('testTitle').value}"`, 'info');
            
            // –ü–æ–¥—Å—á–∏—Ç–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –î–û –æ–ø–µ—Ä–∞—Ü–∏–∏
            try {
                const countBefore = await getDraftsCount();
                log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –î–û –æ–ø–µ—Ä–∞—Ü–∏–∏: ${countBefore}`, 'info');
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É FormData –∫–∞–∫ –≤ Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
                const formData = new FormData();
                formData.append('ad_id', adId);
                formData.append('id', adId); // –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                formData.append('title', document.getElementById('testTitle').value);
                formData.append('description', document.getElementById('testDescription').value);
                formData.append('specialty', '–¢–µ—Å—Ç–æ–≤–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
                formData.append('phone', '+7 (999) 999-99-99');
                
                log(`‚úÖ FormData –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å ad_id: ${adId}`, 'success');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç –ë–ï–ó CSRF
                const response = await fetch('/test-draft', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log(`üì° –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –ü–û–°–õ–ï –æ–ø–µ—Ä–∞—Ü–∏–∏: ${result.total_drafts}`, 'info');
                    log(`üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç ID: ${result.ad_id}`, 'info');
                    log(`üîÑ –ë—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω: ${result.was_updated ? '–î–ê' : '–ù–ï–¢'}`, result.was_updated ? 'success' : 'warning');
                    
                    if (result.was_updated) {
                        log(`üéâ –£–°–ü–ï–•! –ß–µ—Ä–Ω–æ–≤–∏–∫ ID=${adId} –±—ã–ª –û–ë–ù–û–í–õ–ï–ù`, 'success');
                        log(`‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!`, 'success');
                    } else {
                        log(`‚ö†Ô∏è –ë—ã–ª —Å–æ–∑–¥–∞–Ω –ù–û–í–´–ô —á–µ—Ä–Ω–æ–≤–∏–∫ ID=${result.ad_id}`, 'warning');
                        log(`‚ùì –í–æ–∑–º–æ–∂–Ω–æ, —á–µ—Ä–Ω–æ–≤–∏–∫ —Å ID=${adId} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'warning');
                    }
                    
                    if (countBefore == result.total_drafts) {
                        log(`‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ: ${countBefore} -> ${result.total_drafts}`, 'success');
                    } else {
                        log(`üìà –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤: ${countBefore} -> ${result.total_drafts}`, 'info');
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function getDraftsCount() {
            try {
                const response = await fetch('/api/drafts-count', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.count;
                } else {
                    log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤`, 'warning');
                    return '?';
                }
            } catch (error) {
                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ${error.message}`, 'warning');
                return '?';
            }
        }
        
        async function checkDraftsCount() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤...', 'info');
            const count = await getDraftsCount();
            log(`üìä –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤: ${count}`, 'info');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            document.getElementById('testTitle').value = `–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ${new Date().toLocaleTimeString()}`;
            document.getElementById('testDescription').value = `–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${new Date().toLocaleString()}`;
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ (—Ç–µ—Å—Ç)" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è', 'info');
        };
    </script>
</body>
</html>