<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–†–û–°–¢–û–ô –¢–ï–°–¢ - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 30px; }
        .test-block { border: 2px solid #007bff; padding: 25px; margin: 20px 0; border-radius: 10px; background: #f8f9ff; }
        .success { background-color: #d4edda; border-color: #28a745; }
        .error { background-color: #f8d7da; border-color: #dc3545; }
        button { padding: 15px 30px; margin: 10px 0; cursor: pointer; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; }
        .btn-test { background-color: #28a745; color: white; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .log { background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto; }
        h1 { color: #007bff; text-align: center; }
        h2 { color: #28a745; }
    </style>
</head>
<body>
    <h1>üîß –ü–†–û–°–¢–û–ô –¢–ï–°–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</h1>
    
    <div class="test-block">
        <h2>üéØ –ó–∞–¥–∞—á–∞ —Ç–µ—Å—Ç–∞</h2>
        <p><strong>–ü–†–û–ë–õ–ï–ú–ê:</strong> –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫</p>
        <p><strong>–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:</strong> Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç ID –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ</p>
        <p><strong>–û–ñ–ò–î–ê–ï–¢–°–Ø:</strong> "‚úÖ –ß–µ—Ä–Ω–æ–≤–∏–∫ –û–ë–ù–û–í–õ–ï–ù, –Ω–µ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π"</p>
    </div>

    <div class="test-block">
        <h2>üß™ –¢–µ—Å—Ç</h2>
        <label>ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</label>
        <input type="number" id="testAdId" value="5" placeholder="ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞">
        
        <button onclick="runTest()" class="btn-test">
            üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –¢–ï–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø
        </button>
        
        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
        <div id="testResult" class="log">
            –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞...
        </div>
    </div>

    <script>
        function log(message, isSuccess = null) {
            const result = document.getElementById('testResult');
            const color = isSuccess === true ? '#28a745' : isSuccess === false ? '#dc3545' : '#333';
            result.innerHTML += `<div style="color: ${color}; margin: 5px 0;">${message}</div>`;
            result.scrollTop = result.scrollHeight;
        }

        async function runTest() {
            const testBlocks = document.querySelectorAll('.test-block');
            const testBlock = testBlocks[testBlocks.length - 1]; // –ü–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫
            if (testBlock) testBlock.className = 'test-block'; // –°–±—Ä–æ—Å —Å—Ç–∏–ª—è
            
            document.getElementById('testResult').innerHTML = '';
            
            const adId = document.getElementById('testAdId').value;
            
            if (!adId || adId <= 0) {
                log('‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (–±–æ–ª—å—à–µ 0)', false);
                return;
            }
            
            log('üé¨ –°–¢–ê–†–¢ –¢–ï–°–¢–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø');
            log(`üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ ID: ${adId}`);
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –î–û –æ–ø–µ—Ä–∞—Ü–∏–∏
                const countResponse = await fetch('/test-drafts-count');
                const countBefore = countResponse.ok ? (await countResponse.json()).count : 0;
                log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –î–û: ${countBefore}`);
                
                // 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const timestamp = new Date().toLocaleTimeString();
                const formData = new FormData();
                formData.append('ad_id', adId); // –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï!
                formData.append('id', adId);
                formData.append('title', `–ü–†–û–°–¢–û–ô –¢–ï–°–¢ ${timestamp}`);
                formData.append('description', `–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ ${new Date().toLocaleString()}`);
                formData.append('specialty', '–¢–µ—Å—Ç–æ–≤–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
                formData.append('phone', '+7 (999) 123-45-67');
                
                log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã —Å ad_id: ${adId}`);
                
                // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å...');
                
                const response = await fetch('/test-draft-fix', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    log(`üìä –ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –ü–û–°–õ–ï: ${result.total_drafts}`);
                    log(`üéØ ID —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${result.ad_id}`);
                    
                    // 4. –ì–õ–ê–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
                    if (result.was_updated && result.ad_id == adId) {
                        log(`üéâ –£–°–ü–ï–•! –ß–µ—Ä–Ω–æ–≤–∏–∫ ID=${adId} –±—ã–ª –û–ë–ù–û–í–õ–ï–ù!`, true);
                        log('‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û!', true);
                        if (testBlock) testBlock.className = 'test-block success';
                        
                        if (countBefore == result.total_drafts) {
                            log(`‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ: ${countBefore} = ${result.total_drafts}`, true);
                        }
                    } else {
                        log(`‚ùå –ü–†–û–í–ê–õ! –°–æ–∑–¥–∞–Ω –ù–û–í–´–ô —á–µ—Ä–Ω–æ–≤–∏–∫ ID=${result.ad_id}`, false);
                        log('‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï –†–ê–ë–û–¢–ê–ï–¢!', false);
                        if (testBlock) testBlock.className = 'test-block error';
                        log(`üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —á–µ—Ä–Ω–æ–≤–∏–∫ ID=${adId} –≤ –ë–î?`);
                    }
                    
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê: ${response.status}`, false);
                    log(`üìÑ ${errorText.substring(0, 100)}...`, false);
                    if (testBlock) testBlock.className = 'test-block error';
                }
                
            } catch (error) {
                log(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, false);
                if (testBlock) testBlock.className = 'test-block error';
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
        window.onload = function() {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
            log('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —á–µ—Ä–Ω–æ–≤–∏–∫ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        };
    </script>
</body>
</html>