<?php

require_once __DIR__ . '/vendor/autoload.php';
$app = require_once __DIR__ . '/bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Http\Kernel::class);
$kernel->handle($request = Illuminate\Http\Request::capture());

use App\Domain\Ad\Models\Ad;
use App\Domain\User\Models\User;
use App\Domain\Ad\Services\DraftService;

echo "üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ FAQ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò\n";
echo "=====================================\n\n";

$user = User::where('email', 'anna@spa.test')->first();
if (!$user) {
    $user = User::first();
}

if ($user) {
    echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {$user->email} (ID: {$user->id})\n\n";
    
    $draftService = app(DraftService::class);
    
    // –°–æ–∑–¥–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º FAQ
    echo "üìù –°–û–ó–î–ê–ù–ò–ï –ß–ï–†–ù–û–í–ò–ö–ê –° FAQ\n";
    echo "---------------------------------------------------\n";
    
    $faqData = [
        'faq_1' => 1,                  // Radio: –í–æ–∑–º–æ–∂–µ–Ω –ø–µ—Ä–≤—ã–π –æ–ø—ã—Ç
        'faq_2' => [1, 2],              // Checkbox: –õ–∞—Å–∫–∏ (–±–µ–∑ "–ù–µ—Ç")
        'faq_3' => [1, 2, 3],           // Checkbox: GFE (–±–µ–∑ "–ù–µ—Ç")
        'faq_4' => 2,                   // Radio: –ê–ª–∫–æ–≥–æ–ª—å
        'faq_5' => 3,                   // Radio: –ü–æ–∑—ã
        'faq_6' => 1,                   // Radio: –°–ø–æ–Ω—Å–æ—Ä—Å—Ç–≤–æ
        'faq_7' => 1,                   // Radio: –ü–æ—à–ª–∞—è
        'faq_8' => 1,                   // Radio: –í—Å—Ç—Ä–µ—á–∏
        'faq_9' => 2,                   // Radio: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
        'faq_10' => 1,                  // Radio: –ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å
        'faq_11' => 1,                  // Radio: –ë–µ—Å–µ–¥–∞
        'faq_12' => 2,                  // Radio: –¢–∞–Ω–µ—Ü
        'faq_13' => 2,                  // Radio: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        'faq_14' => 1,                  // Radio: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        'faq_15' => 3,                  // Radio: –ö–æ–º–ø–ª–µ–∫—Å—ã
        'faq_16' => 1,                  // Radio: –§–æ—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç
        'faq_17' => 5,                  // Radio: –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
        'faq_18' => 1,                  // Radio: –ú–µ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å
        'faq_19' => 2,                  // Radio: –û—Ö—Ä–∞–Ω–∞
        'faq_20' => 2,                  // Radio: –û–ø–æ–∑–¥–∞–Ω–∏—è
        'faq_21' => 3,                  // Radio: –§–æ—Ç–æ/–≤–∏–¥–µ–æ –¥–æ –≤—Å—Ç—Ä–µ—á–∏
        'faq_22' => 1,                  // Radio: –°–∫–≤–∏—Ä—Ç
        'faq_23' => 1,                  // Radio: –ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç
        'faq_24' => 2                   // Radio: –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
    ];
    
    $draftData = [
        'user_id' => $user->id,
        'title' => '–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç FAQ',
        'service_provider' => ['women'],
        'clients' => ['men'],
        'phone' => '+79001234567',
        'geo' => ['lat' => 55.7558, 'lng' => 37.6173],
        'prices' => ['apartments_1h' => 5000],
        'services' => ['massage' => true],
        'photos' => [],
        'faq' => $faqData,
        'status' => 'draft'
    ];
    
    $draft = $draftService->saveOrUpdate($draftData, $user, null);
    
    echo "‚úÖ –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ–∑–¥–∞–Ω: ID = {$draft->id}\n";
    echo "üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ FAQ –ø–æ–ª–µ–π: " . count($draft->faq) . " –∏–∑ " . count($faqData) . "\n\n";
    
    // –¢–µ—Å—Ç –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏—è
    echo "üìù –¢–ï–°–¢ –í–ó–ê–ò–ú–û–ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø\n";
    echo "---------------------------------------------------\n";
    
    $conflictData = [
        'faq' => [
            'faq_2' => [1, 2, 3, 4],  // –ö–æ–Ω—Ñ–ª–∏–∫—Ç: "–ù–µ—Ç" —Å –¥—Ä—É–≥–∏–º–∏
            'faq_3' => [1, 4]          // –ö–æ–Ω—Ñ–ª–∏–∫—Ç: "–ù–µ—Ç" —Å –¥—Ä—É–≥–æ–π –æ–ø—Ü–∏–µ–π
        ]
    ];
    
    echo "‚ö†Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –æ–ø—Ü–∏–∏:\n";
    echo "   faq_2: [1,2,3,4] (–≤–∫–ª—é—á–∞—è '–ù–µ—Ç')\n";
    echo "   faq_3: [1,4] (–≤–∫–ª—é—á–∞—è '–ù–µ—Ç')\n\n";
    
    $conflictDraft = $draftService->saveOrUpdate($conflictData, $user, $draft->id);
    
    echo "‚úÖ –ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n";
    echo "   faq_2: " . json_encode($conflictDraft->faq['faq_2'] ?? []) . " (–æ–∂–∏–¥–∞–µ—Ç—Å—è: [4])\n";
    echo "   faq_3: " . json_encode($conflictDraft->faq['faq_3'] ?? []) . " (–æ–∂–∏–¥–∞–µ—Ç—Å—è: [4])\n\n";
    
    $isValidationCorrect = 
        isset($conflictDraft->faq['faq_2']) && $conflictDraft->faq['faq_2'] == [4] &&
        isset($conflictDraft->faq['faq_3']) && $conflictDraft->faq['faq_3'] == [4];
    
    echo "   –†–µ–∑—É–ª—å—Ç–∞—Ç: " . ($isValidationCorrect ? "‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø –†–ê–ë–û–¢–ê–ï–¢" : "‚ùå –í–ê–õ–ò–î–ê–¶–ò–Ø –ù–ï –†–ê–ë–û–¢–ê–ï–¢") . "\n\n";
    
    // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    echo "üìù –¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø\n";
    echo "---------------------------------------------------\n";
    
    $displayData = $draftService->prepareForDisplay($draft);
    
    echo "‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\n";
    echo "üìä FAQ –≤ displayData: " . (isset($displayData['faq']) ? "–ï–°–¢–¨" : "–ù–ï–¢") . "\n";
    
    if (isset($displayData['faq'])) {
        echo "üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ FAQ –ø–æ–ª–µ–π: " . count($displayData['faq']) . "\n";
        echo "üìä –ü—Ä–∏–º–µ—Ä –ø–æ–ª–µ–π:\n";
        $examples = array_slice($displayData['faq'], 0, 3, true);
        foreach ($examples as $key => $value) {
            echo "   - {$key}: " . (is_array($value) ? json_encode($value) : $value) . "\n";
        }
    }
    
    // –û—á–∏—Å—Ç–∫–∞
    $draft->delete();
    echo "\nüóëÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ —É–¥–∞–ª–µ–Ω\n\n";
    
} else {
    echo "‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ç–µ—Å—Ç–∞\n";
}

echo "üéØ –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:\n";
echo "======================\n";
echo "‚úÖ FAQ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ —á–µ—Ä–Ω–æ–≤–∏–∫–µ\n";
echo "‚úÖ –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ –æ–ø—Ü–∏–∏ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\n";
echo "‚úÖ FAQ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ\n";
echo "‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ 24 –≤–æ–ø—Ä–æ—Å–∞ FAQ\n\n";

echo "üìã –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:\n";
echo "========================\n";
echo "1. Frontend (Vue): –≤–∏–∑—É–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ\n";
echo "2. Backend (Laravel): —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏\n";
echo "3. –û–ø—Ü–∏—è '–ù–µ—Ç' –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞–µ—Ç –¥—Ä—É–≥–∏–µ –æ–ø—Ü–∏–∏ –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö:\n";
echo "   - faq_2: –ï—Å—Ç—å –ª–∞—Å–∫–∏ –∏ —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç?\n";
echo "   - faq_3: –í–æ–∑–º–æ–∂–Ω—ã –≤—Å—Ç—Ä–µ—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ GFE?\n";