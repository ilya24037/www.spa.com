–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
–≠–¢–ê–ü 1: –ü–û–î–ì–û–¢–û–í–ö–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´ (30 –º–∏–Ω—É—Ç)
–®–∞–≥ 1.1: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
bash
# –°–æ–∑–¥–∞–π —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
mkdir -p storage/app/media
mkdir -p storage/app/temp
mkdir -p storage/app/cache
mkdir -p storage/backups/media

# –£—Å—Ç–∞–Ω–æ–≤–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod -R 755 storage/app/media
chmod -R 755 storage/app/temp
chmod -R 755 storage/app/cache
–®–∞–≥ 1.2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
bash
# –í—ã–ø–æ–ª–Ω–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
composer require intervention/image-laravel
composer require intervention/image
composer require ramsey/uuid
–®–∞–≥ 1.3: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
bash
php artisan vendor:publish --provider="Intervention\Image\Laravel\ServiceProvider"
________________________________________
–≠–¢–ê–ü 2: –°–û–ó–î–ê–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• (20 –º–∏–Ω—É—Ç)
–®–∞–≥ 2.1: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è media_files
bash
php artisan make:migration create_media_files_table
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
php
// database/migrations/2024_xx_xx_create_media_files_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::create('media_files', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('master_id')->constrained('masters')->onDelete('cascade');
            $table->string('original_name');
            $table->string('stored_name');
            $table->string('file_path', 500);
            $table->string('file_hash', 64);
            $table->string('mime_type', 100);
            $table->bigInteger('file_size');
            $table->integer('width')->nullable();
            $table->integer('height')->nullable();
            $table->integer('sort_order')->default(0);
            $table->boolean('is_primary')->default(false);
            $table->json('metadata')->nullable();
            $table->timestamps();
            
            $table->index(['master_id', 'sort_order']);
            $table->index('file_hash');
            $table->index('uuid');
        });
    }

    public function down()
    {
        Schema::dropIfExists('media_files');
    }
};
–®–∞–≥ 2.2: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è image_versions
bash
php artisan make:migration create_image_versions_table
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
php
// database/migrations/2024_xx_xx_create_image_versions_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::create('image_versions', function (Blueprint $table) {
            $table->id();
            $table->foreignId('media_file_id')->constrained('media_files')->onDelete('cascade');
            $table->enum('version_type', ['thumbnail', 'medium', 'large']);
            $table->enum('format', ['jpeg', 'webp']);
            $table->string('file_path', 500);
            $table->bigInteger('file_size');
            $table->integer('width');
            $table->integer('height');
            $table->timestamps();
            
            $table->index(['media_file_id', 'version_type']);
        });
    }

    public function down()
    {
        Schema::dropIfExists('image_versions');
    }
};
–®–∞–≥ 2.3: –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
bash
php artisan migrate
________________________________________
–≠–¢–ê–ü 3: –°–û–ó–î–ê–ù–ò–ï –°–ï–†–í–ò–°–û–í (1 —á–∞—Å)
–®–∞–≥ 3.1: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—É—Ç–µ–π
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: app/Services/Media/FilePathService.php
php
<?php

namespace App\Services\Media;

use Illuminate\Support\Str;

class FilePathService
{
    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
     */
    public function generateSecureFilename(string $originalName): string
    {
        $extension = pathinfo($originalName, PATHINFO_EXTENSION);
        $timestamp = time();
        $uuid = Str::uuid()->toString();
        
        return sprintf('%s_%s.%s', $timestamp, $uuid, strtolower($extension));
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞ (–∫–∞–∫ –Ω–∞ –±–æ–ª—å—à–∏—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö)
     */
    public function generateHashPath(string $filename): string
    {
        $hash = md5($filename);
        $dir1 = substr($hash, 0, 2);
        $dir2 = substr($hash, 2, 2);
        
        return sprintf('%s/%s/%s', $dir1, $dir2, $filename);
    }
    
    /**
     * –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    public function getFullPath(string $filename): string
    {
        return 'media/' . $this->generateHashPath($filename);
    }
    
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
     */
    public function ensureDirectoryExists(string $path): void
    {
        $directory = storage_path('app/' . dirname($path));
        
        if (!file_exists($directory)) {
            mkdir($directory, 0755, true);
        }
    }
}
–®–∞–≥ 3.2: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: app/Services/Media/ImageOptimizationService.php
php
<?php

namespace App\Services\Media;

use Intervention\Image\Laravel\Facades\Image;
use Illuminate\Support\Facades\Storage;

class ImageOptimizationService
{
    private array $sizes = [
        'thumbnail' => [
            'width' => 300,
            'height' => 300,
            'quality' => 80
        ],
        'medium' => [
            'width' => 800,
            'height' => 800,
            'quality' => 85
        ],
        'large' => [
            'width' => 1200,
            'height' => 1200,
            'quality' => 90
        ]
    ];
    
    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    public function processImage(string $originalPath): array
    {
        $results = [];
        $pathInfo = pathinfo($originalPath);
        $directory = $pathInfo['dirname'];
        $filename = $pathInfo['filename'];
        
        foreach ($this->sizes as $sizeName => $config) {
            // –°–æ–∑–¥–∞–µ–º JPEG –≤–µ—Ä—Å–∏—é
            $jpegFilename = sprintf('%s_%s.jpg', $filename, $sizeName);
            $jpegPath = $directory . '/' . $jpegFilename;
            
            $image = Image::read(storage_path('app/' . $originalPath));
            
            // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
            $image->scale($config['width'], $config['height']);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º JPEG
            $image->toJpeg($config['quality'])
                  ->save(storage_path('app/' . $jpegPath));
            
            // –°–æ–∑–¥–∞–µ–º WebP –≤–µ—Ä—Å–∏—é
            $webpFilename = sprintf('%s_%s.webp', $filename, $sizeName);
            $webpPath = $directory . '/' . $webpFilename;
            
            $image->toWebp($config['quality'])
                  ->save(storage_path('app/' . $webpPath));
            
            $results[$sizeName] = [
                'jpeg' => [
                    'path' => $jpegPath,
                    'size' => filesize(storage_path('app/' . $jpegPath)),
                    'width' => $image->width(),
                    'height' => $image->height()
                ],
                'webp' => [
                    'path' => $webpPath,
                    'size' => filesize(storage_path('app/' . $webpPath)),
                    'width' => $image->width(),
                    'height' => $image->height()
                ]
            ];
        }
        
        return $results;
    }
    
    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    public function deleteAllVersions(string $originalPath): void
    {
        $pathInfo = pathinfo($originalPath);
        $directory = $pathInfo['dirname'];
        $filename = $pathInfo['filename'];
        
        foreach ($this->sizes as $sizeName => $config) {
            Storage::delete($directory . '/' . $filename . '_' . $sizeName . '.jpg');
            Storage::delete($directory . '/' . $filename . '_' . $sizeName . '.webp');
        }
    }
}
–®–∞–≥ 3.3: –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: app/Services/Media/MediaService.php
php
<?php

namespace App\Services\Media;

use App\Models\MediaFile;
use App\Models\ImageVersion;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class MediaService
{
    public function __construct(
        private FilePathService $pathService,
        private ImageOptimizationService $imageService
    ) {}
    
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    public function uploadImage(UploadedFile $file, int $masterId): MediaFile
    {
        return DB::transaction(function () use ($file, $masterId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ
            $existingCount = MediaFile::where('master_id', $masterId)->count();
            if ($existingCount >= 10) {
                throw new \Exception('–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ –Ω–∞ –º–∞—Å—Ç–µ—Ä–∞');
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è
            $originalName = $file->getClientOriginalName();
            $storedName = $this->pathService->generateSecureFilename($originalName);
            $fullPath = $this->pathService->getFullPath($storedName);
            
            // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            $this->pathService->ensureDirectoryExists($fullPath);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            $file->storeAs(dirname($fullPath), basename($fullPath));
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
            $imageInfo = getimagesize(storage_path('app/' . $fullPath));
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î
            $mediaFile = MediaFile::create([
                'uuid' => Str::uuid(),
                'master_id' => $masterId,
                'original_name' => $originalName,
                'stored_name' => $storedName,
                'file_path' => $fullPath,
                'file_hash' => md5_file(storage_path('app/' . $fullPath)),
                'mime_type' => $file->getMimeType(),
                'file_size' => $file->getSize(),
                'width' => $imageInfo[0] ?? null,
                'height' => $imageInfo[1] ?? null,
                'sort_order' => $existingCount,
                'is_primary' => $existingCount === 0
            ]);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            $this->processImageVersions($mediaFile);
            
            return $mediaFile;
        });
    }
    
    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ—Ä—Å–∏–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    public function processImageVersions(MediaFile $mediaFile): void
    {
        $versions = $this->imageService->processImage($mediaFile->file_path);
        
        foreach ($versions as $versionType => $formats) {
            foreach ($formats as $format => $data) {
                ImageVersion::create([
                    'media_file_id' => $mediaFile->id,
                    'version_type' => $versionType,
                    'format' => $format === 'jpeg' ? 'jpeg' : 'webp',
                    'file_path' => $data['path'],
                    'file_size' => $data['size'],
                    'width' => $data['width'],
                    'height' => $data['height']
                ]);
            }
        }
    }
    
    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞
     */
    public function deleteMedia(MediaFile $mediaFile): bool
    {
        return DB::transaction(function () use ($mediaFile) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
            $this->imageService->deleteAllVersions($mediaFile->file_path);
            
            // –£–¥–∞–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            Storage::delete($mediaFile->file_path);
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î (–≤–µ—Ä—Å–∏–∏ —É–¥–∞–ª—è—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ)
            return $mediaFile->delete();
        });
    }
    
    /**
     * –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Ñ–æ—Ç–æ
     */
    public function reorderPhotos(int $masterId, array $photoIds): void
    {
        foreach ($photoIds as $order => $photoId) {
            MediaFile::where('id', $photoId)
                ->where('master_id', $masterId)
                ->update(['sort_order' => $order]);
        }
    }
    
    /**
     * –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ
     */
    public function setPrimaryPhoto(int $masterId, int $photoId): void
    {
        DB::transaction(function () use ($masterId, $photoId) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≥–ª–∞–≤–Ω–æ–µ
            MediaFile::where('master_id', $masterId)
                ->update(['is_primary' => false]);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ
            MediaFile::where('id', $photoId)
                ->where('master_id', $masterId)
                ->update(['is_primary' => true]);
        });
    }
}
________________________________________
–≠–¢–ê–ü 4: –°–û–ó–î–ê–ù–ò–ï –ú–û–î–ï–õ–ï–ô (20 –º–∏–Ω—É—Ç)
–®–∞–≥ 4.1: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ MediaFile
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: app/Models/MediaFile.php
php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Support\Facades\Storage;

class MediaFile extends Model
{
    protected $fillable = [
        'uuid',
        'master_id',
        'original_name',
        'stored_name',
        'file_path',
        'file_hash',
        'mime_type',
        'file_size',
        'width',
        'height',
        'sort_order',
        'is_primary',
        'metadata'
    ];
    
    protected $casts = [
        'metadata' => 'array',
        'is_primary' => 'boolean',
        'file_size' => 'integer',
        'width' => 'integer',
        'height' => 'integer',
        'sort_order' => 'integer'
    ];
    
    /**
     * –ú–∞—Å—Ç–µ—Ä –≤–ª–∞–¥–µ–ª–µ—Ü
     */
    public function master(): BelongsTo
    {
        return $this->belongsTo(Master::class);
    }
    
    /**
     * –í–µ—Ä—Å–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    public function versions(): HasMany
    {
        return $this->hasMany(ImageVersion::class);
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å URL –¥–ª—è –≤–µ—Ä—Å–∏–∏
     */
    public function getUrl(string $version = 'medium', string $format = 'jpeg'): string
    {
        $imageVersion = $this->versions()
            ->where('version_type', $version)
            ->where('format', $format)
            ->first();
        
        if ($imageVersion) {
            return Storage::url($imageVersion->file_path);
        }
        
        return Storage::url($this->file_path);
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π URL
     */
    public function getSignedUrl(string $version = 'medium'): string
    {
        return route('media.show', [
            'uuid' => $this->uuid,
            'version' => $version,
            'signature' => $this->generateSignature($version)
        ]);
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è URL
     */
    private function generateSignature(string $version): string
    {
        return hash_hmac('sha256', $this->uuid . $version, config('app.key'));
    }
    
    /**
     * –†–∞–∑–º–µ—Ä –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
     */
    public function getHumanSize(): string
    {
        $bytes = $this->file_size;
        $units = ['B', 'KB', 'MB', 'GB'];
        
        for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
            $bytes /= 1024;
        }
        
        return round($bytes, 2) . ' ' . $units[$i];
    }
}
–®–∞–≥ 4.2: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ ImageVersion
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: app/Models/ImageVersion.php
php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class ImageVersion extends Model
{
    protected $fillable = [
        'media_file_id',
        'version_type',
        'format',
        'file_path',
        'file_size',
        'width',
        'height'
    ];
    
    protected $casts = [
        'file_size' => 'integer',
        'width' => 'integer',
        'height' => 'integer'
    ];
    
    /**
     * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ–¥–∏–∞-—Ñ–∞–π–ª
     */
    public function mediaFile(): BelongsTo
    {
        return $this->belongsTo(MediaFile::class);
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å URL –≤–µ—Ä—Å–∏–∏
     */
    public function getUrl(): string
    {
        return asset('storage/' . $this->file_path);
    }
}
________________________________________
–≠–¢–ê–ü 5: –°–û–ó–î–ê–ù–ò–ï –ö–û–ù–¢–†–û–õ–õ–ï–†–ê (30 –º–∏–Ω—É—Ç)
–®–∞–≥ 5.1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–ª—è –º–µ–¥–∏–∞
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: app/Http/Controllers/MasterMediaController.php
php
<?php

namespace App\Http\Controllers;

use App\Models\Master;
use App\Models\MediaFile;
use App\Services\Media\MediaService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\RateLimiter;
use Inertia\Inertia;

class MasterMediaController extends Controller
{
    public function __construct(
        private MediaService $mediaService
    ) {}
    
    /**
     * –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞
     */
    public function index(Master $master)
    {
        $this->authorize('update', $master);
        
        $mediaFiles = $master->mediaFiles()
            ->with('versions')
            ->orderBy('sort_order')
            ->get();
        
        return Inertia::render('Master/Media/Index', [
            'master' => $master,
            'mediaFiles' => $mediaFiles
        ]);
    }
    
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
     */
    public function upload(Request $request, Master $master)
    {
        $this->authorize('update', $master);
        
        // Rate limiting: 10 –∑–∞–≥—Ä—É–∑–æ–∫ –≤ –º–∏–Ω—É—Ç—É
        $key = 'upload:' . $request->user()->id;
        if (RateLimiter::tooManyAttempts($key, 10)) {
            return response()->json([
                'message' => '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
            ], 429);
        }
        RateLimiter::increment($key);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        $request->validate([
            'photo' => [
                'required',
                'image',
                'mimes:jpeg,jpg,png,webp',
                'max:10240', // 10MB
                'dimensions:min_width=300,min_height=300,max_width=5000,max_height=5000'
            ]
        ]);
        
        try {
            $mediaFile = $this->mediaService->uploadImage(
                $request->file('photo'),
                $master->id
            );
            
            return response()->json([
                'success' => true,
                'media' => $mediaFile->load('versions')
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 422);
        }
    }
    
    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
     */
    public function destroy(Master $master, MediaFile $mediaFile)
    {
        $this->authorize('update', $master);
        
        if ($mediaFile->master_id !== $master->id) {
            abort(403, '–§–æ—Ç–æ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ–º—É –º–∞—Å—Ç–µ—Ä—É');
        }
        
        $this->mediaService->deleteMedia($mediaFile);
        
        return response()->json([
            'success' => true,
            'message' => '–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ'
        ]);
    }
    
    /**
     * –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Ñ–æ—Ç–æ
     */
    public function reorder(Request $request, Master $master)
    {
        $this->authorize('update', $master);
        
        $request->validate([
            'photo_ids' => 'required|array',
            'photo_ids.*' => 'exists:media_files,id'
        ]);
        
        $this->mediaService->reorderPhotos($master->id, $request->photo_ids);
        
        return response()->json([
            'success' => true,
            'message' => '–ü–æ—Ä—è–¥–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω'
        ]);
    }
    
    /**
     * –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ
     */
    public function setPrimary(Master $master, MediaFile $mediaFile)
    {
        $this->authorize('update', $master);
        
        if ($mediaFile->master_id !== $master->id) {
            abort(403, '–§–æ—Ç–æ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ–º—É –º–∞—Å—Ç–µ—Ä—É');
        }
        
        $this->mediaService->setPrimaryPhoto($master->id, $mediaFile->id);
        
        return response()->json([
            'success' => true,
            'message' => '–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'
        ]);
    }
    
    /**
     * –û—Ç–¥–∞—á–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∏)
     */
    public function show(Request $request, string $uuid)
    {
        $mediaFile = MediaFile::where('uuid', $uuid)->firstOrFail();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        if ($request->has('signature')) {
            $expectedSignature = hash_hmac(
                'sha256',
                $uuid . $request->get('version', 'medium'),
                config('app.key')
            );
            
            if (!hash_equals($expectedSignature, $request->signature)) {
                abort(403, 'Invalid signature');
            }
        }
        
        $version = $request->get('version', 'medium');
        $format = $request->get('format', 'jpeg');
        
        $imageVersion = $mediaFile->versions()
            ->where('version_type', $version)
            ->where('format', $format)
            ->first();
        
        if (!$imageVersion) {
            abort(404, 'Version not found');
        }
        
        $path = storage_path('app/' . $imageVersion->file_path);
        
        return response()->file($path, [
            'Cache-Control' => 'public, max-age=31536000, immutable',
            'ETag' => md5_file($path)
        ]);
    }
}
________________________________________
–≠–¢–ê–ü 6: –°–û–ó–î–ê–ù–ò–ï –†–û–£–¢–û–í (10 –º–∏–Ω—É—Ç)
–®–∞–≥ 6.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ—É—Ç–æ–≤ –≤ web.php
–î–æ–±–∞–≤—å –≤ —Ñ–∞–π–ª: routes/web.php
php
use App\Http\Controllers\MasterMediaController;

// –ì—Ä—É–ø–ø–∞ —Ä–æ—É—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
Route::middleware(['auth'])->group(function () {
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞ –º–∞—Å—Ç–µ—Ä–∞
    Route::prefix('masters/{master}/media')->name('masters.media.')->group(function () {
        Route::get('/', [MasterMediaController::class, 'index'])->name('index');
        Route::post('/upload', [MasterMediaController::class, 'upload'])->name('upload');
        Route::delete('/{mediaFile}', [MasterMediaController::class, 'destroy'])->name('destroy');
        Route::post('/reorder', [MasterMediaController::class, 'reorder'])->name('reorder');
        Route::post('/{mediaFile}/set-primary', [MasterMediaController::class, 'setPrimary'])->name('set-primary');
    });
});

// –ü—É–±–ª–∏—á–Ω—ã–π —Ä–æ—É—Ç –¥–ª—è –æ—Ç–¥–∞—á–∏ –º–µ–¥–∏–∞
Route::get('/media/{uuid}', [MasterMediaController::class, 'show'])->name('media.show');
________________________________________
–≠–¢–ê–ü 7: –°–û–ó–î–ê–ù–ò–ï FRONTEND –ö–û–ú–ü–û–ù–ï–ù–¢–ê (40 –º–∏–Ω—É—Ç)
–®–∞–≥ 7.1: –°–æ–∑–¥–∞–Ω–∏–µ Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: resources/js/Pages/Master/Media/Index.vue
vue
<template>
    <div class="master-media-page">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏</h1>
        
        <!-- –°—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ -->
        <div class="photo-counter">
            –ó–∞–≥—Ä—É–∂–µ–Ω–æ {{ photos.length }} –∏–∑ 10 —Ñ–æ—Ç–æ
        </div>
        
        <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div 
            v-if="photos.length < 10"
            class="upload-zone"
            @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false"
            @drop.prevent="handleDrop"
            :class="{ 'dragging': isDragging }"
        >
            <input 
                ref="fileInput"
                type="file"
                accept="image/*"
                multiple
                @change="handleFileSelect"
                style="display: none"
            >
            
            <div @click="$refs.fileInput.click()" class="upload-content">
                <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                <p class="text-sm text-gray-500">
                    JPG, PNG –∏–ª–∏ WebP. –ú–∞–∫—Å–∏–º—É–º 10MB
                </p>
            </div>
        </div>
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div v-if="uploadProgress > 0 && uploadProgress < 100" class="upload-progress">
            <div class="progress-bar">
                <div class="progress-fill" :style="{ width: uploadProgress + '%' }"></div>
            </div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞: {{ uploadProgress }}%</p>
        </div>
        
        <!-- –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ -->
        <div class="photo-gallery">
            <draggable 
                v-model="photos" 
                @end="handleReorder"
                item-key="id"
                class="gallery-grid"
            >
                <template #item="{ element }">
                    <div class="photo-item" :class="{ 'primary': element.is_primary }">
                        <img 
                            :src="getPhotoUrl(element, 'medium')"
                            :alt="element.original_name"
                            loading="lazy"
                        >
                        
                        <div class="photo-actions">
                            <button 
                                v-if="!element.is_primary"
                                @click="setPrimary(element.id)"
                                class="btn-primary"
                                title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º"
                            >
                                ‚≠ê
                            </button>
                            
                            <button 
                                @click="deletePhoto(element.id)"
                                class="btn-delete"
                                title="–£–¥–∞–ª–∏—Ç—å"
                            >
                                üóëÔ∏è
                            </button>
                        </div>
                        
                        <div v-if="element.is_primary" class="primary-badge">
                            –ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
                        </div>
                    </div>
                </template>
            </draggable>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
        <div v-if="errors.length" class="errors">
            <div v-for="error in errors" :key="error" class="error-message">
                {{ error }}
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { useForm, router } from '@inertiajs/vue3'
import draggable from 'vuedraggable'
import axios from 'axios'

const props = defineProps({
    master: Object,
    mediaFiles: Array
})

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
const photos = ref(props.mediaFiles || [])
const isDragging = ref(false)
const uploadProgress = ref(0)
const errors = ref([])

// –ü–æ–ª—É—á–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ
const getPhotoUrl = (photo, version = 'medium') => {
    const imageVersion = photo.versions?.find(v => 
        v.version_type === version && v.format === 'jpeg'
    )
    return imageVersion ? `/storage/${imageVersion.file_path}` : '#'
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
const handleFileSelect = (event) => {
    const files = Array.from(event.target.files)
    uploadFiles(files)
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
const handleDrop = (event) => {
    isDragging.value = false
    const files = Array.from(event.dataTransfer.files)
    uploadFiles(files)
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
const uploadFiles = async (files) => {
    errors.value = []
    
    for (const file of files) {
        if (photos.value.length >= 10) {
            errors.value.push('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ 10 —Ñ–æ—Ç–æ')
            break
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞
        if (!file.type.startsWith('image/')) {
            errors.value.push(`${file.name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`)
            continue
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
        if (file.size > 10 * 1024 * 1024) {
            errors.value.push(`${file.name} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –≤ 10MB`)
            continue
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞
        const formData = new FormData()
        formData.append('photo', file)
        
        try {
            const response = await axios.post(
                `/masters/${props.master.id}/media/upload`,
                formData,
                {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    },
                    onUploadProgress: (progressEvent) => {
                        uploadProgress.value = Math.round(
                            (progressEvent.loaded * 100) / progressEvent.total
                        )
                    }
                }
            )
            
            if (response.data.success) {
                photos.value.push(response.data.media)
            }
        } catch (error) {
            errors.value.push(
                error.response?.data?.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
            )
        }
    }
    
    uploadProgress.value = 0
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞
const handleReorder = async () => {
    const photoIds = photos.value.map(p => p.id)
    
    try {
        await axios.post(`/masters/${props.master.id}/media/reorder`, {
            photo_ids: photoIds
        })
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞:', error)
    }
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ
const setPrimary = async (photoId) => {
    try {
        const response = await axios.post(
            `/masters/${props.master.id}/media/${photoId}/set-primary`
        )
        
        if (response.data.success) {
            photos.value.forEach(p => {
                p.is_primary = p.id === photoId
            })
        }
    } catch (error) {
        errors.value.push('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ')
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
const deletePhoto = async (photoId) => {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) return
    
    try {
        const response = await axios.delete(
            `/masters/${props.master.id}/media/${photoId}`
        )
        
        if (response.data.success) {
            photos.value = photos.value.filter(p => p.id !== photoId)
        }
    } catch (error) {
        errors.value.push('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ')
    }
}
</script>

<style scoped>
.master-media-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.photo-counter {
    margin-bottom: 1rem;
    font-size: 1.1rem;
    color: #666;
}

.upload-zone {
    border: 2px dashed #cbd5e0;
    border-radius: 0.5rem;
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 2rem;
}

.upload-zone:hover,
.upload-zone.dragging {
    border-color: #4299e1;
    background-color: #f7fafc;
}

.upload-icon {
    width: 4rem;
    height: 4rem;
    margin: 0 auto 1rem;
    color: #a0aec0;
}

.upload-progress {
    margin: 1rem 0;
}

.progress-bar {
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #4299e1;
    transition: width 0.3s;
}

.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.photo-item {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.photo-item.primary {
    box-shadow: 0 0 0 3px #4299e1;
}

.photo-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.photo-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s;
}

.photo-item:hover .photo-actions {
    opacity: 1;
}

.photo-actions button {
    padding: 0.25rem 0.5rem;
    background: white;
    border-radius: 0.25rem;
    border: 1px solid #e2e8f0;
    cursor: pointer;
}

.primary-badge {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: #4299e1;
    color: white;
    padding: 0.25rem;
    text-align: center;
    font-size: 0.875rem;
}

.errors {
    margin-top: 1rem;
}

.error-message {
    padding: 0.75rem;
    background: #fee;
    color: #c53030;
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
}
</style>
________________________________________
–≠–¢–ê–ü 8: –ù–ê–°–¢–†–û–ô–ö–ê –û–ß–ï–†–ï–î–ï–ô (15 –º–∏–Ω—É—Ç)
–®–∞–≥ 8.1: –°–æ–∑–¥–∞–Ω–∏–µ Job –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª: app/Jobs/ProcessUploadedImage.php
php
<?php

namespace App\Jobs;

use App\Models\MediaFile;
use App\Services\Media\ImageOptimizationService;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;

class ProcessUploadedImage implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;
    
    public $timeout = 120;
    public $tries = 3;
    
    public function __construct(
        private int $mediaFileId
    ) {}
    
    public function handle(ImageOptimizationService $optimizer): void
    {
        $mediaFile = MediaFile::findOrFail($this->mediaFileId);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ—Ä—Å–∏–π
        $versions = $optimizer->processImage($mediaFile->file_path);
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        foreach ($versions as $versionType => $formats) {
            foreach ($formats as $format => $data) {
                $mediaFile->versions()->create([
                    'version_type' => $versionType,
                    'format' => $format === 'jpeg' ? 'jpeg' : 'webp',
                    'file_path' => $data['path'],
                    'file_size' => $data['size'],
                    'width' => $data['width'],
                    'height' => $data['height']
                ]);
            }
        }
    }
}
–®–∞–≥ 8.2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—á–µ—Ä–µ–¥–µ–π
–û–±–Ω–æ–≤–∏ —Ñ–∞–π–ª: config/queue.php
php
'connections' => [
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    
    'media' => [
        'driver' => 'database',
        'table' => 'jobs',
        'queue' => 'media',
        'retry_after' => 300,
    ],
],
________________________________________
–≠–¢–ê–ü 9: –°–û–ó–î–ê–ù–ò–ï –ö–û–ú–ê–ù–î –î–õ–Ø –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–Ø (20 –º–∏–Ω—É—Ç)
–®–∞–≥ 9.1: –ö–æ–º–∞–Ω–¥–∞ –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
–°–æ–∑–¥–∞–π –∫–æ–º–∞–Ω–¥—É:
bash
php artisan make:command CleanTempMedia
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞: app/Console/Commands/CleanTempMedia.php
php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Storage;
use Carbon\Carbon;

class CleanTempMedia extends Command
{
    protected $signature = 'media:clean-temp';
    protected $description = '–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤';
    
    public function handle(): int
    {
        $tempPath = storage_path('app/temp');
        $deletedCount = 0;
        
        if (!is_dir($tempPath)) {
            $this->info('–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return 0;
        }
        
        $files = glob($tempPath . '/*');
        
        foreach ($files as $file) {
            // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
            if (filemtime($file) < time() - 86400) {
                unlink($file);
                $deletedCount++;
            }
        }
        
        $this->info("–£–¥–∞–ª–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {$deletedCount}");
        
        return 0;
    }
}
–®–∞–≥ 9.2: –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
–°–æ–∑–¥–∞–π –∫–æ–º–∞–Ω–¥—É:
bash
php artisan make:command MediaHealthCheck
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞: app/Console/Commands/MediaHealthCheck.php
php
<?php

namespace App\Console\Commands;

use App\Models\MediaFile;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Storage;

class MediaHealthCheck extends Command
{
    protected $signature = 'media:health-check';
    protected $description = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤';
    
    public function handle(): int
    {
        $this->info('–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤...');
        
        $missingFiles = [];
        $corruptedFiles = [];
        
        MediaFile::chunk(100, function ($mediaFiles) use (&$missingFiles, &$corruptedFiles) {
            foreach ($mediaFiles as $mediaFile) {
                $path = storage_path('app/' . $mediaFile->file_path);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
                if (!file_exists($path)) {
                    $missingFiles[] = $mediaFile->id;
                    continue;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–µ—à–∞
                $currentHash = md5_file($path);
                if ($currentHash !== $mediaFile->file_hash) {
                    $corruptedFiles[] = $mediaFile->id;
                }
            }
        });
        
        if (count($missingFiles) > 0) {
            $this->error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã: ' . implode(', ', $missingFiles));
        }
        
        if (count($corruptedFiles) > 0) {
            $this->error('–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: ' . implode(', ', $corruptedFiles));
        }
        
        if (count($missingFiles) === 0 && count($corruptedFiles) === 0) {
            $this->info('–í—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–æ—Ä—è–¥–∫–µ!');
        }
        
        return 0;
    }
}
________________________________________
–≠–¢–ê–ü 10: –ù–ê–°–¢–†–û–ô–ö–ê CRON –ò –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê (15 –º–∏–Ω—É—Ç)
–®–∞–≥ 10.1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
–û–±–Ω–æ–≤–∏ —Ñ–∞–π–ª: app/Console/Kernel.php
php
protected function schedule(Schedule $schedule)
{
    // –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∫–∞–∂–¥—ã–π —á–∞—Å
    $schedule->command('media:clean-temp')->hourly();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–≤–∞ —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å
    $schedule->command('media:health-check')
        ->twiceDaily(1, 13)
        ->emailOutputTo('admin@example.com');
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –º–µ–¥–∏–∞
    $schedule->command('queue:work --queue=media --max-jobs=10')
        ->everyMinute()
        ->withoutOverlapping();
}
–®–∞–≥ 10.2: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
bash
# 1. –ü—Ä–æ–≤–µ—Ä—å –º–∏–≥—Ä–∞—Ü–∏–∏
php artisan migrate:status

# 2. –û—á–∏—Å—Ç–∏ –∫–µ—à
php artisan cache:clear
php artisan config:clear
php artisan route:clear

# 3. –°–æ–∑–¥–∞–π —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –¥–ª—è storage
php artisan storage:link

# 4. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod -R 755 storage/app/media
chmod -R 755 storage/app/temp

# 5. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏
php artisan tinker
>>> $file = \Illuminate\Http\UploadedFile::fake()->image('test.jpg', 800, 600);
>>> app(\App\Services\Media\MediaService::class)->uploadImage($file, 1);
________________________________________
–ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
‚Ä¢	 –°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã media_files –∏ image_versions
‚Ä¢	 –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –∏ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
‚Ä¢	 –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 10 —Ñ–æ—Ç–æ
‚úÖ –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:
‚Ä¢	 –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ —Å —Ö–µ—à-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º–∏
‚Ä¢	 –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
‚Ä¢	 –°–æ–∑–¥–∞–Ω–∞ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ storage
‚úÖ Backend:
‚Ä¢	 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–µ—Ä–≤–∏—Å FilePathService
‚Ä¢	 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–µ—Ä–≤–∏—Å ImageOptimizationService
‚Ä¢	 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–µ—Ä–≤–∏—Å MediaService
‚Ä¢	 –°–æ–∑–¥–∞–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä MasterMediaController
‚Ä¢	 –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ä–æ—É—Ç—ã
‚Ä¢	 –î–æ–±–∞–≤–ª–µ–Ω—ã Jobs –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π
‚úÖ Frontend:
‚Ä¢	 –°–æ–∑–¥–∞–Ω Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞
‚Ä¢	 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω drag & drop
‚Ä¢	 –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ç–æ
‚Ä¢	 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤—ã–±–æ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ
‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
‚Ä¢	 –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è 3 —Ä–∞–∑–º–µ—Ä–∞ + –æ—Ä–∏–≥–∏–Ω–∞–ª
‚Ä¢	 –°–æ–∑–¥–∞—é—Ç—Å—è WebP –≤–µ—Ä—Å–∏–∏
‚Ä¢	 –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢	 –î–æ–±–∞–≤–ª–µ–Ω lazy loading
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
‚Ä¢	 –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è UUID –¥–ª—è —Ñ–∞–π–ª–æ–≤
‚Ä¢	 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ö–µ—à-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫
‚Ä¢	 –î–æ–±–∞–≤–ª–µ–Ω rate limiting
‚Ä¢	 –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
‚úÖ –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:
‚Ä¢	 –ö–æ–º–∞–Ω–¥–∞ –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
‚Ä¢	 –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
‚Ä¢	 –ù–∞—Å—Ç—Ä–æ–µ–Ω cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
‚Ä¢	 –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
________________________________________
–ö–û–ú–ê–ù–î–ê –î–õ–Ø –°–¢–ê–†–¢–ê
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–∏:
bash
# –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
php artisan migrate && \
php artisan storage:link && \
php artisan queue:work --queue=media &

