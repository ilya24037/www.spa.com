<template>
    <AppLayout>
        <Head title="–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" />
        
        <div class="min-h-screen bg-gray-50">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex gap-6">
                    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –í–°–ï–ì–î–ê –í–ò–î–ù–ê (–∫–∞–∫ –Ω–∞ –ê–≤–∏—Ç–æ) -->
                    <aside class="w-80 flex-shrink-0">
                        <div class="bg-white rounded-lg shadow-sm sticky top-6">
                            <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                            <div class="p-6 border-b">
                                <div class="flex items-center gap-4">
                                    <!-- –ê–≤–∞—Ç–∞—Ä -->
                                    <div class="relative">
                                        <div 
                                            class="w-16 h-16 rounded-full bg-pink-500 flex items-center justify-center text-white text-2xl font-bold"
                                            :style="{ backgroundColor: avatarColor }"
                                        >
                                            {{ userInitial }}
                                        </div>
                                        <Link 
                                            href="/profile/edit" 
                                            class="absolute bottom-0 right-0 w-6 h-6 bg-white rounded-full shadow-md flex items-center justify-center hover:bg-gray-50"
                                        >
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                            </svg>
                                        </Link>
                                    </div>
                                    
                                    <!-- –ò–º—è –∏ —Ä–µ–π—Ç–∏–Ω–≥ -->
                                    <div>
                                        <h3 class="font-semibold text-lg">{{ user?.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</h3>
                                        <Link 
                                            href="/profile/reviews" 
                                            class="flex items-center gap-2 text-sm text-gray-600 hover:text-blue-600"
                                        >
                                            <span class="font-medium">{{ userStats?.rating || '‚Äî' }}</span>
                                            <div class="flex">
                                                <svg 
                                                    v-for="i in 5" 
                                                    :key="i"
                                                    class="w-4 h-4"
                                                    :class="i <= Math.floor(userStats?.rating || 0) ? 'text-yellow-400' : 'text-gray-300'"
                                                    fill="currentColor"
                                                    viewBox="0 0 20 20"
                                                >
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                </svg>
                                            </div>
                                            <span class="text-xs">{{ userStats?.reviewsCount || 0 }} –æ—Ç–∑—ã–≤–æ–≤</span>
                                        </Link>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –í–°–ï–ì–î–ê –î–û–°–¢–£–ü–ù–û -->
                            <nav class="py-2">
                                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã -->
                                <div class="px-3 py-2">
                                    <ul class="space-y-1">
                                        <li>
                                            <Link 
                                                href="/profile"
                                                :class="menuItemClass(route().current('profile.dashboard'))"
                                            >
                                                –ú–æ–∏ –∞–Ω–∫–µ—Ç—ã
                                                <span v-if="counts?.profiles > 0" class="ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded">
                                                    {{ counts.profiles }}
                                                </span>
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/bookings"
                                                :class="menuItemClass(route().current('bookings.index'))"
                                            >
                                                –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                                <span v-if="counts?.bookings > 0" class="ml-auto text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">
                                                    {{ counts.bookings }}
                                                </span>
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/profile/reviews"
                                                :class="menuItemClass(route().current('profile.reviews'))"
                                            >
                                                –ú–æ–∏ –æ—Ç–∑—ã–≤—ã
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/favorites"
                                                :class="menuItemClass(route().current('favorites.index'))"
                                            >
                                                –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                                                <span v-if="counts?.favorites > 0" class="ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded">
                                                    {{ counts.favorites }}
                                                </span>
                                            </Link>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="border-t my-2"></div>
                                
                                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                                <div class="px-3 py-2">
                                    <ul class="space-y-1">
                                        <li>
                                            <Link 
                                                href="/messages"
                                                :class="menuItemClass(route().current('messages.index'))"
                                            >
                                                –°–æ–æ–±—â–µ–Ω–∏—è
                                                <span v-if="counts?.unreadMessages > 0" class="ml-auto text-xs bg-red-500 text-white px-2 py-0.5 rounded">
                                                    {{ counts.unreadMessages }}
                                                </span>
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/notifications"
                                                :class="menuItemClass(route().current('notifications.index'))"
                                            >
                                                –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                                            </Link>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="border-t my-2"></div>
                                
                                <!-- –§–∏–Ω–∞–Ω—Å—ã –∏ —É—Å–ª—É–≥–∏ -->
                                <div class="px-3 py-2">
                                    <ul class="space-y-1">
                                        <li>
                                            <Link 
                                                href="/wallet"
                                                :class="menuItemClass(route().current('wallet.index'))"
                                            >
                                                –ö–æ—à–µ–ª—ë–∫
                                                <span class="ml-auto text-sm font-medium">
                                                    {{ formatPrice(userStats?.balance || 0) }}
                                                </span>
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/services"
                                                :class="menuItemClass(route().current('services.index'))"
                                            >
                                                –ü–ª–∞—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/subscription"
                                                :class="menuItemClass(route().current('subscription.index'))"
                                            >
                                                –î–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤
                                                <span class="ml-auto text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded">
                                                    –ù–æ–≤–æ–µ
                                                </span>
                                            </Link>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="border-t my-2"></div>
                                
                                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                                <div class="px-3 py-2">
                                    <ul class="space-y-1">
                                        <li>
                                            <Link 
                                                href="/profile/edit"
                                                :class="menuItemClass(route().current('profile.edit'))"
                                            >
                                                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/profile/security"
                                                :class="menuItemClass(route().current('profile.security'))"
                                            >
                                                –ó–∞—â–∏—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è
                                            </Link>
                                        </li>
                                        <li>
                                            <Link 
                                                href="/settings"
                                                :class="menuItemClass(route().current('settings.index'))"
                                            >
                                                –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                                            </Link>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                            
                            <!-- –ë–∞–Ω–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
                            <div class="p-4 border-t">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <p class="text-sm font-medium mb-2">–°–∫–∞—á–∞–π—Ç–µ<br>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
                                    <p class="text-xs text-gray-600 mb-3">
                                        –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∞–Ω–∫–µ—Ç–∞–º–∏<br>–≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
                                    </p>
                                    <div class="flex gap-2">
                                        <a href="#" class="text-xs bg-black text-white px-3 py-1.5 rounded flex items-center gap-1">
                                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                                            </svg>
                                            App Store
                                        </a>
                                        <a href="#" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded flex items-center gap-1">
                                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M3,20.5V3.5C3,2.91 3.34,2.39 3.84,2.15L13.69,12L3.84,21.85C3.34,21.6 3,21.09 3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08 20.75,11.5 20.75,12C20.75,12.5 20.53,12.9 20.18,13.18L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z"/>
                                            </svg>
                                            Google Play
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                    
                    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ) -->
                    <main class="flex-1">
                        <div class="bg-white rounded-lg shadow-sm">
                            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
                            <div class="p-6 border-b">
                                <div class="flex items-center justify-between">
                                    <h1 class="text-2xl font-bold">–ú–æ–∏ –∞–Ω–∫–µ—Ç—ã</h1>
                                    <Link 
                                        href="/masters/create"
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
                                    </Link>
                                </div>
                            </div>
                            
                            <!-- –í–∫–ª–∞–¥–∫–∏ -->
                            <div class="border-b">
                                <nav class="flex px-6" aria-label="Tabs">
                                    <button
                                        v-for="tab in tabs"
                                        :key="tab.id"
                                        @click="activeTab = tab.id"
                                        :class="[
                                            'px-4 py-4 text-sm font-medium border-b-2 transition',
                                            activeTab === tab.id
                                                ? 'border-blue-600 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        ]"
                                    >
                                        {{ tab.name }}
                                        <span 
                                            v-if="tab.count > 0"
                                            :class="[
                                                'ml-2 px-2 py-0.5 text-xs rounded-full',
                                                activeTab === tab.id
                                                    ? 'bg-blue-100 text-blue-600'
                                                    : 'bg-gray-100 text-gray-600'
                                            ]"
                                        >
                                            {{ tab.count }}
                                        </span>
                                    </button>
                                </nav>
                            </div>
                            
                            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö) -->
                            <div class="p-6">
                                <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã -->
                                <div v-if="activeTab === 'active'" class="space-y-4">
                                    <ProfileCard 
                                        v-for="profile in activeProfiles"
                                        :key="profile.id"
                                        :profile="profile"
                                        @edit="editProfile"
                                        @delete="deleteProfile"
                                        @toggle="toggleProfile"
                                    />
                                    
                                    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                                    <div v-if="activeProfiles.length === 0" class="text-center py-12">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <h3 class="mt-2 text-sm font-medium text-gray-900">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–Ω–∫–µ—Ç</h3>
                                        <p class="mt-1 text-sm text-gray-500">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∞–Ω–∫–µ—Ç—É –º–∞—Å—Ç–µ—Ä–∞</p>
                                        <div class="mt-6">
                                            <Link 
                                                href="/masters/create"
                                                class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
                                            >
                                                –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
                                            </Link>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ -->
                                <div v-if="activeTab === 'draft'" class="space-y-4">
                                    <ProfileCard 
                                        v-for="profile in draftProfiles"
                                        :key="profile.id"
                                        :profile="profile"
                                        :is-draft="true"
                                        @edit="editProfile"
                                        @delete="deleteProfile"
                                        @publish="publishProfile"
                                    />
                                    
                                    <EmptyState 
                                        v-if="draftProfiles.length === 0"
                                        title="–ù–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤"
                                        description="–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã"
                                    />
                                </div>
                                
                                <!-- –ê—Ä—Ö–∏–≤ -->
                                <div v-if="activeTab === 'archive'" class="space-y-4">
                                    <ProfileCard 
                                        v-for="profile in archivedProfiles"
                                        :key="profile.id"
                                        :profile="profile"
                                        :is-archived="true"
                                        @restore="restoreProfile"
                                        @delete="deleteProfile"
                                    />
                                    
                                    <EmptyState 
                                        v-if="archivedProfiles.length === 0"
                                        title="–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç"
                                        description="–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã"
                                    />
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </AppLayout>
</template>

<script setup>
import { ref, computed } from 'vue'
import { Head, Link, router, usePage } from '@inertiajs/vue3'  // üî• –î–æ–±–∞–≤–ª–µ–Ω usePage
import { route } from 'ziggy-js'
import AppLayout from '@/Layouts/AppLayout.vue'
import ProfileCard from '@/Components/Dashboard/ProfileCard.vue'
import EmptyState from '@/Components/Dashboard/EmptyState.vue'

const props = defineProps({
    profiles: {
        type: Array,
        default: () => []  // üî• –ó–∞—â–∏—Ç–∞ –æ—Ç undefined
    },
    counts: {
        type: Object,
        default: () => ({
            profiles: 0,
            bookings: 0,
            favorites: 0,
            unreadMessages: 0
        })
    },
    userStats: {
        type: Object,
        default: () => ({
            rating: 0,
            reviewsCount: 0,
            balance: 0
        })
    }
})

const user = computed(() => usePage().props.auth.user)
const userInitial = computed(() => user.value?.name?.charAt(0)?.toUpperCase() || 'U')  // üî• –ó–∞—â–∏—Ç–∞ –æ—Ç undefined

// –¶–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏
const colors = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#00bcd4', '#009688', '#4caf50', '#ff9800', '#ff5722']
const avatarColor = computed(() => {
    const charCode = user.value?.name?.charCodeAt(0) || 85  // 85 = 'U'
    return colors[charCode % colors.length]
})

// –í–∫–ª–∞–¥–∫–∏
const activeTab = ref('active')
const tabs = computed(() => [
    { 
        id: 'active', 
        name: '–ê–∫—Ç–∏–≤–Ω—ã–µ', 
        count: activeProfiles.value.length 
    },
    { 
        id: 'draft', 
        name: '–ß–µ—Ä–Ω–æ–≤–∏–∫–∏', 
        count: draftProfiles.value.length 
    },
    { 
        id: 'archive', 
        name: '–ê—Ä—Ö–∏–≤', 
        count: archivedProfiles.value.length 
    }
])

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç undefined)
const activeProfiles = computed(() => 
    props.profiles?.filter(p => p.status === 'active') || []
)
const draftProfiles = computed(() => 
    props.profiles?.filter(p => p.status === 'draft') || []
)
const archivedProfiles = computed(() => 
    props.profiles?.filter(p => p.status === 'archived') || []
)

// –ö–ª–∞—Å—Å –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
const menuItemClass = (isActive) => [
    'flex items-center justify-between px-3 py-2 text-sm rounded-lg transition',
    isActive 
        ? 'bg-blue-50 text-blue-600 font-medium' 
        : 'text-gray-700 hover:bg-gray-50'
]

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
const formatPrice = (price) => {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
    }).format(price)
}

// –î–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏
const editProfile = (profile) => {
    router.get(`/masters/${profile.id}/edit`)
}

const deleteProfile = (profile) => {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∞–Ω–∫–µ—Ç—É?')) {
        router.delete(`/masters/${profile.id}`)
    }
}

const toggleProfile = (profile) => {
    router.patch(`/masters/${profile.id}/toggle`)
}

const publishProfile = (profile) => {
    router.patch(`/masters/${profile.id}/publish`)
}

const restoreProfile = (profile) => {
    router.patch(`/masters/${profile.id}/restore`)
}
</script>