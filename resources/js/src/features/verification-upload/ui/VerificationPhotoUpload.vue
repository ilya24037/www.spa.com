<template>
  <div class="verification-photo-upload">
    <!-- –ë–ª–æ–∫ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-6">
      <div class="flex items-start gap-3">
        <div class="text-2xl">‚ú®</div>
        <div>
          <h3 class="font-semibold text-blue-900 mb-2">–ü–æ–ª—É—á–∏—Ç–µ –∑–Ω–∞—á–æ–∫ "–§–æ—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ"</h3>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>üìà +40% –±–æ–ª—å—à–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∞–Ω–∫–µ—Ç—ã</li>
            <li>üîù –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –≤—ã–¥–∞—á–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</li>
            <li>üîí –§–æ—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º (–Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è)</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="bg-white border-2 border-gray-200 rounded-lg p-6 mb-6">
      <h3 class="font-semibold text-lg mb-4 text-center">–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–µ —Ñ–æ—Ç–æ?</h3>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- –®–∞–≥ 1 -->
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg">
            1
          </div>
          <div class="flex-1">
            <h4 class="font-semibold mb-2">–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ª–∏—Å—Ç–æ–∫</h4>
            <div class="bg-gray-50 border border-gray-300 rounded p-3 mb-2">
              <p class="text-sm mb-1">–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç —Ä—É–∫–∏:</p>
              <div class="font-mono bg-white p-2 rounded border">
                <div class="font-bold">{{ currentDate }}</div>
                <div class="font-bold">–¥–ª—è FEIPITER</div>
              </div>
            </div>
            <p class="text-xs text-gray-600">‚úçÔ∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∏—à–∏—Ç–µ –æ—Ç —Ä—É–∫–∏</p>
          </div>
        </div>

        <!-- –®–∞–≥ 2 -->
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg">
            2
          </div>
          <div class="flex-1">
            <h4 class="font-semibold mb-2">–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ</h4>
            <ul class="text-sm text-gray-700 space-y-2">
              <li class="flex items-start gap-2">
                <span class="text-green-500">‚úì</span>
                <span>–î–µ—Ä–∂–∏—Ç–µ –ª–∏—Å—Ç–æ–∫ –≤ —Ä—É–∫–µ</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-green-500">‚úì</span>
                <span>–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ –≤–∞—à–µ —Ç–µ–ª–æ</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-green-500">‚úì</span>
                <span>–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —á–∏—Ç–∞—Ç—å—Å—è</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-green-500">‚úì</span>
                <span>–ö–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ –≤ –∞–Ω–∫–µ—Ç–µ</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="!currentFile && !uploadedPath" class="upload-zone">
      <label
        class="upload-label bg-gray-50 hover:bg-blue-50"
        :class="{ 'dragging': isDragging, 'bg-blue-50 border-blue-400': isDragging }"
        @dragover.prevent="isDragging = true"
        @dragleave.prevent="isDragging = false"
        @drop.prevent="handleDrop"
      >
        <input
          ref="fileInput"
          type="file"
          accept="image/jpeg,image/jpg,image/png"
          class="hidden"
          @change="handleFileSelect"
          :disabled="uploading"
        >

        <div class="upload-content">
          <svg class="w-12 h-12 text-gray-400 mb-3 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>

          <p class="text-lg font-medium text-gray-700 mb-1">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –≤ —ç—Ç—É –æ–±–ª–∞—Å—Ç—å
          </p>
          <p class="text-sm text-gray-500 mb-3">
            –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É
          </p>
          <button type="button" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium">
            –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–µ —Ñ–æ—Ç–æ
          </button>
          <p class="text-xs text-gray-400 mt-3">
            JPG, PNG –¥–æ 15 –ú–ë
          </p>
        </div>
      </label>
    </div>
    
    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div v-if="currentFile || uploadedPath" class="preview mt-4">
      <div class="relative inline-block">
        <img 
          :src="previewUrl || uploadedPath"
          alt="–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–µ —Ñ–æ—Ç–æ"
          class="max-h-64 rounded-lg border border-gray-300"
        >
        
        <!-- –°—Ç–∞—Ç—É—Å -->
        <div v-if="uploading" class="absolute inset-0 bg-black bg-opacity-50 rounded-lg flex items-center justify-center">
          <div class="text-white">
            <svg class="animate-spin h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            –ó–∞–≥—Ä—É–∑–∫–∞...
          </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div v-if="!uploading" class="mt-2 flex gap-2">
          <button
            v-if="!uploadedPath"
            @click="uploadPhoto"
            class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
          >
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
          </button>
          <button
            @click="removePhoto"
            class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
          >
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
    
    <!-- –û—à–∏–±–∫–∞ -->
    <div v-if="error" class="mt-4 bg-red-50 border border-red-200 rounded-lg p-3">
      <p class="text-sm text-red-600">{{ error }}</p>
    </div>
    
    <!-- –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="mt-6 flex flex-col sm:flex-row gap-4 text-xs text-gray-600">
      <div class="flex items-start gap-2">
        <span>‚è∞</span>
        <div>
          <strong>–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å:</strong><br>
          –î–ª—è –Ω–æ–≤—ã—Ö –∞–Ω–∫–µ—Ç - –Ω–µ —Å—Ç–∞—Ä—à–µ –Ω–µ–¥–µ–ª–∏
        </div>
      </div>
      <div class="flex items-start gap-2">
        <span>üìÖ</span>
        <div>
          <strong>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong><br>
          4 –º–µ—Å—è—Ü–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å)
        </div>
      </div>
      <div class="flex items-start gap-2">
        <span>‚ö°</span>
        <div>
          <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞:</strong><br>
          –î–æ 24 —á–∞—Å–æ–≤
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ç–æ (—Å–ø–æ–π–ª–µ—Ä) -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800 select-none">
        –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ
      </summary>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <!-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä -->
        <div class="border-2 border-green-200 rounded-lg p-3 bg-green-50">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-green-500 text-xl">‚úì</span>
            <span class="font-semibold text-green-700">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</span>
          </div>
          <ul class="text-xs text-gray-600 space-y-1">
            <li>‚Ä¢ –í–∏–¥–Ω–æ –ª–∏—Ü–æ –∏ —Ç–µ–ª–æ</li>
            <li>‚Ä¢ –õ–∏—Å—Ç–æ–∫ —Å –¥–∞—Ç–æ–π –≤ —Ä—É–∫–µ</li>
            <li>‚Ä¢ –¢–µ–∫—Å—Ç —á–∏—Ç–∞–µ—Ç—Å—è —á–µ—Ç–∫–æ</li>
            <li>‚Ä¢ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ç–æ –≤ –∞–Ω–∫–µ—Ç–µ</li>
          </ul>
        </div>
        <!-- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä -->
        <div class="border-2 border-red-200 rounded-lg p-3 bg-red-50">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-red-500 text-xl">‚úó</span>
            <span class="font-semibold text-red-700">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</span>
          </div>
          <ul class="text-xs text-gray-600 space-y-1">
            <li>‚Ä¢ –¢–æ–ª—å–∫–æ –ª–∏—Å—Ç–æ–∫ –±–µ–∑ —á–µ–ª–æ–≤–µ–∫–∞</li>
            <li>‚Ä¢ –ù–µ—á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç</li>
            <li>‚Ä¢ –°—Ç–∞—Ä–∞—è –¥–∞—Ç–∞</li>
            <li>‚Ä¢ –ù–µ –≤–∏–¥–Ω–æ —Ç–µ–ª–æ</li>
          </ul>
        </div>
      </div>
    </details>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { verificationApi } from '../api/verificationApi'

interface Props {
  adId: number
  currentPhoto?: string | null
  status?: string
}

const props = defineProps<Props>()

const emit = defineEmits<{
  uploaded: [path: string]
  deleted: []
}>()

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
const fileInput = ref<HTMLInputElement>()
const currentFile = ref<File | null>(null)
const uploadedPath = ref<string | null>(props.currentPhoto || null)
const previewUrl = ref<string | null>(null)
const isDragging = ref(false)
const uploading = ref(false)
const error = ref<string | null>(null)

// –í—ã—á–∏—Å–ª—è–µ–º—ã–µ
const currentDate = computed(() => {
  const date = new Date()
  return date.toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  })
})

// –ú–µ—Ç–æ–¥—ã
const handleFileSelect = (event: Event) => {
  const target = event.target as HTMLInputElement
  if (target.files && target.files[0]) {
    selectFile(target.files[0])
  }
}

const handleDrop = (event: DragEvent) => {
  isDragging.value = false
  if (event.dataTransfer?.files && event.dataTransfer.files[0]) {
    selectFile(event.dataTransfer.files[0])
  }
}

const selectFile = (file: File) => {
  error.value = null
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!['image/jpeg', 'image/jpg', 'image/png'].includes(file.type)) {
    error.value = '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã JPG, PNG'
    return
  }
  
  if (file.size > 10 * 1024 * 1024) {
    error.value = '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 10MB'
    return
  }
  
  currentFile.value = file
  
  // –°–æ–∑–¥–∞–µ–º preview
  const reader = new FileReader()
  reader.onload = (e) => {
    previewUrl.value = e.target?.result as string
  }
  reader.readAsDataURL(file)
}

const uploadPhoto = async () => {
  if (!currentFile.value) return
  
  uploading.value = true
  error.value = null
  
  try {
    const result = await verificationApi.uploadPhoto(props.adId, currentFile.value)
    
    if (result.success) {
      uploadedPath.value = result.path || null
      currentFile.value = null
      previewUrl.value = null
      emit('uploaded', result.path!)
    } else {
      error.value = result.message
    }
  } catch (err: any) {
    error.value = err.response?.data?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ'
  } finally {
    uploading.value = false
  }
}

const removePhoto = async () => {
  if (uploadedPath.value) {
    try {
      await verificationApi.deleteFiles(props.adId)
      emit('deleted')
    } catch (err) {
      console.error('Failed to delete photo:', err)
    }
  }
  
  currentFile.value = null
  previewUrl.value = null
  uploadedPath.value = null
  error.value = null
  
  if (fileInput.value) {
    fileInput.value.value = ''
  }
}

const handleImageError = (event: Event) => {
  const target = event.target as HTMLImageElement
  target.style.display = 'none'
}

// Watchers
watch(() => props.currentPhoto, (newVal) => {
  if (newVal && !currentFile.value) {
    uploadedPath.value = newVal
  }
})
</script>

<style scoped>
.upload-label {
  @apply block w-full cursor-pointer;
  @apply border-2 border-dashed border-gray-300 rounded-lg;
  @apply hover:border-blue-400 transition-all duration-200;
  @apply p-8 text-center;
}

.upload-label.dragging {
  @apply border-blue-500;
}

.upload-content {
  @apply flex flex-col items-center;
}

.upload-content button {
  @apply pointer-events-none;
}
</style>