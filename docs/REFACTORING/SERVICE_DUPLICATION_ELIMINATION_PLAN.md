# üöÄ –ü–õ–ê–ù –£–°–¢–†–ê–ù–ï–ù–ò–Ø –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø –°–ï–†–í–ò–°–û–í

## üìä –ê–ù–ê–õ–ò–ó –¢–ï–ö–£–©–ï–ô –°–ò–¢–£–ê–¶–ò–ò

### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–í—Å–µ–≥–æ —Å–µ—Ä–≤–∏—Å–æ–≤:** 76 —Ñ–∞–π–ª–æ–≤
- **–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:** 23 —Ñ–∞–π–ª–∞
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:** 70% (53 —Ñ–∞–π–ª–∞)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è (24 —á–∞—Å–∞)

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –¥–æ–º–µ–Ω—ã:

#### üì¶ Domain/Booking/Services (26 —Å–µ—Ä–≤–∏—Å–æ–≤)
**–ü—Ä–æ–±–ª–µ–º—ã:**
- 5 –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –æ–¥–Ω–æ–π –ª–æ–≥–∏–∫–∏
- 4 —Å–µ—Ä–≤–∏—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- 4 —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ª–æ—Ç–∞–º–∏
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ—Ç–º–µ–Ω—ã/–ø–µ—Ä–µ–Ω–æ—Å–∞

#### üí≥ Domain/Payment/Services (30 —Å–µ—Ä–≤–∏—Å–æ–≤)
**–ü—Ä–æ–±–ª–µ–º—ã:**
- 5 —Ñ–∏–ª—å—Ç—Ä-—Å–µ—Ä–≤–∏—Å–æ–≤ (–º–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ 1)
- 4 refund-—Å–µ—Ä–≤–∏—Å–∞
- –ü–æ 4 —Ñ–∞–π–ª–∞ –Ω–∞ –∫–∞–∂–¥—ã–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π —à–ª—é–∑
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤

#### üîé Domain/Search/Services (20 —Å–µ—Ä–≤–∏—Å–æ–≤)
**–ü—Ä–æ–±–ª–µ–º—ã:**
- 8 –º–µ–ª–∫–∏—Ö handlers –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
- 6 —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
- –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –≥—Ä–∞–Ω—É–ª—è—Ü–∏—è

---

## üìÖ –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê –ü–û –î–ù–Ø–ú

### üóìÔ∏è –î–ï–ù–¨ 1: Domain/Booking - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
**–í—Ä–µ–º—è:** 8 —á–∞—Å–æ–≤  
**–¶–µ–ª—å:** 26 ‚Üí 7 —Å–µ—Ä–≤–∏—Å–æ–≤ (-73%)

#### –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
Domain/Booking/Services/
‚îú‚îÄ‚îÄ BookingService.php           # –ì–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
‚îú‚îÄ‚îÄ BookingQueryService.php      # –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã
‚îú‚îÄ‚îÄ BookingValidationService.php # –í—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îú‚îÄ‚îÄ BookingNotificationService.php # –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ BookingSlotService.php       # –°–ª–æ—Ç—ã –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
‚îú‚îÄ‚îÄ BookingPaymentService.php    # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
‚îî‚îÄ‚îÄ BookingStatisticsService.php # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
```

### üóìÔ∏è –î–ï–ù–¨ 2: Domain/Payment - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
**–í—Ä–µ–º—è:** 8 —á–∞—Å–æ–≤  
**–¶–µ–ª—å:** 30 ‚Üí 9 —Å–µ—Ä–≤–∏—Å–æ–≤ (-70%)

#### –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
Domain/Payment/Services/
‚îú‚îÄ‚îÄ PaymentService.php           # –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚îú‚îÄ‚îÄ PaymentProcessorService.php  # –û–±—Ä–∞–±–æ—Ç–∫–∞
‚îú‚îÄ‚îÄ PaymentFilterService.php     # –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
‚îú‚îÄ‚îÄ RefundService.php           # –í—Å–µ –≤–æ–∑–≤—Ä–∞—Ç—ã
‚îú‚îÄ‚îÄ TransactionService.php      # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ SubscriptionService.php     # –ü–æ–¥–ø–∏—Å–∫–∏
‚îî‚îÄ‚îÄ Gateways/
    ‚îú‚îÄ‚îÄ StripeGateway.php       # –í–µ—Å—å Stripe
    ‚îú‚îÄ‚îÄ YooKassaGateway.php     # –í—Å—è YooKassa
    ‚îî‚îÄ‚îÄ SbpGateway.php          # –°–ë–ü
```

### üóìÔ∏è –î–ï–ù–¨ 3: Domain/Search - –£–ø—Ä–æ—â–µ–Ω–∏–µ
**–í—Ä–µ–º—è:** 8 —á–∞—Å–æ–≤  
**–¶–µ–ª—å:** 20 ‚Üí 7 —Å–µ—Ä–≤–∏—Å–æ–≤ (-65%)

#### –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
Domain/Search/Services/
‚îú‚îÄ‚îÄ SearchService.php            # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
‚îú‚îÄ‚îÄ ElasticsearchEngine.php     # ES –¥–≤–∏–∂–æ–∫
‚îú‚îÄ‚îÄ DatabaseSearchEngine.php    # –ë–î –¥–≤–∏–∂–æ–∫
‚îú‚îÄ‚îÄ SearchFilterService.php     # –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
‚îú‚îÄ‚îÄ SearchResultService.php     # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
‚îú‚îÄ‚îÄ SearchAnalyticsService.php  # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îî‚îÄ‚îÄ RecommendationEngine.php    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
```

---

## üîß –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù: –î–ï–ù–¨ 1 - BOOKING

### ‚è∞ 09:00-10:00 - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1 —á–∞—Å)

#### 1. –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞:
```powershell
# PowerShell –∫–æ–º–∞–Ω–¥—ã
$date = Get-Date -Format "yyyyMMdd_HHmm"
$backupPath = "C:\Backup\booking_services_$date"

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
Copy-Item -Path "C:\www.spa.com\app\Domain\Booking\Services" -Destination $backupPath -Recurse

# –°–æ–∑–¥–∞–µ–º –≤–µ—Ç–∫—É –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
cd C:\www.spa.com
git checkout -b refactor/booking-services-deduplication
git add -A
git commit -m "backup: before Booking services refactoring"
```

#### 2. –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```powershell
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
Get-ChildItem -Path "C:\www.spa.com" -Recurse -Filter "*.php" | 
    Select-String -Pattern "BookingValidator|ValidationService|CancellationValidation" | 
    Group-Object Path | 
    Select-Object Name, Count
```

### ‚è∞ 10:00-12:00 - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ (2 —á–∞—Å–∞)

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä

```php
<?php
// app/Domain/Booking/Services/BookingValidationService.php

namespace App\Domain\Booking\Services;

use App\Domain\Booking\Models\Booking;
use App\Domain\User\Models\User;
use App\Domain\Master\Models\MasterProfile;
use Carbon\Carbon;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;

/**
 * –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
 */
class BookingValidationService
{
    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    public function validateCreate(array $data): void
    {
        $validator = Validator::make($data, [
            'master_id' => 'required|exists:master_profiles,id',
            'service_id' => 'required|exists:services,id',
            'date' => 'required|date|after:today',
            'time' => 'required|date_format:H:i',
            'duration' => 'required|integer|min:30|max:480',
            'client_name' => 'required|string|max:255',
            'client_phone' => 'required|string|regex:/^\+7[0-9]{10}$/',
            'client_comment' => 'nullable|string|max:500',
        ]);

        if ($validator->fails()) {
            throw new ValidationException($validator);
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–∑–Ω–µ—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
        $this->validateBusinessRules($data);
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    public function validateCancellation(Booking $booking, User $user): void
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        if ($booking->user_id !== $user->id && !$user->isAdmin()) {
            throw ValidationException::withMessages([
                'user' => '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã —ç—Ç–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'
            ]);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –Ω–∞—á–∞–ª–∞
        $hoursBeforeStart = Carbon::now()->diffInHours($booking->start_at, false);
        if ($hoursBeforeStart < 2 && !$user->isAdmin()) {
            throw ValidationException::withMessages([
                'time' => '–û—Ç–º–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–∞ –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 2 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞'
            ]);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        if (!in_array($booking->status, ['pending', 'confirmed'])) {
            throw ValidationException::withMessages([
                'status' => '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç–∞—Ç—É—Å–µ: ' . $booking->status
            ]);
        }
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    public function validateCompletion(Booking $booking): void
    {
        if ($booking->status !== 'confirmed') {
            throw ValidationException::withMessages([
                'status' => '–ú–æ–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'
            ]);
        }

        if ($booking->end_at->isFuture()) {
            throw ValidationException::withMessages([
                'time' => '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—â–µ –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å'
            ]);
        }
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    public function validateReschedule(Booking $booking, Carbon $newDateTime): void
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞
        $hoursBeforeStart = Carbon::now()->diffInHours($booking->start_at, false);
        if ($hoursBeforeStart < 4) {
            throw ValidationException::withMessages([
                'time' => '–ü–µ—Ä–µ–Ω–æ—Å –≤–æ–∑–º–æ–∂–µ–Ω –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 4 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞'
            ]);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è –≤ –±—É–¥—É—â–µ–º
        if ($newDateTime->isPast()) {
            throw ValidationException::withMessages([
                'date' => '–ù–æ–≤–∞—è –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º'
            ]);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ
        if ($newDateTime->equalTo($booking->start_at)) {
            throw ValidationException::withMessages([
                'date' => '–ù–æ–≤–∞—è –¥–∞—Ç–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–µ–π'
            ]);
        }
    }

    /**
     * –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞
     */
    private function validateBusinessRules(array $data): void
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –º–∞—Å—Ç–µ—Ä–∞
        $master = MasterProfile::find($data['master_id']);
        $dayOfWeek = Carbon::parse($data['date'])->dayOfWeek;
        
        $schedule = $master->schedules()
            ->where('day_of_week', $dayOfWeek)
            ->first();
            
        if (!$schedule || !$schedule->is_working) {
            throw ValidationException::withMessages([
                'date' => '–ú–∞—Å—Ç–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å'
            ]);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
        $requestedTime = Carbon::parse($data['time']);
        $startTime = Carbon::parse($schedule->start_time);
        $endTime = Carbon::parse($schedule->end_time);
        
        if ($requestedTime->lt($startTime) || $requestedTime->gt($endTime)) {
            throw ValidationException::withMessages([
                'time' => '–í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤–Ω–µ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –º–∞—Å—Ç–µ—Ä–∞'
            ]);
        }
    }
}
```

#### –®–∞–≥ 2: –û–±–Ω–æ–≤–ª—è–µ–º BookingService

```powershell
# –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
notepad C:\www.spa.com\app\Domain\Booking\Services\BookingService.php
```

–ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –≤—ã–∑–æ–≤—ã:
```php
// –ë–´–õ–û:
$this->bookingValidator->validate($data);
$this->validationService->validateBookingData($data);
$this->cancellationValidation->validate($booking);

// –°–¢–ê–õ–û:
$this->validationService->validateCreate($data);
$this->validationService->validateCancellation($booking, $user);
```

### ‚è∞ 12:00-14:00 - –û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤

### ‚è∞ 14:00-16:00 - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (2 —á–∞—Å–∞)

#### –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

```php
<?php
// app/Domain/Booking/Services/BookingNotificationService.php

namespace App\Domain\Booking\Services;

use App\Domain\Booking\Models\Booking;
use App\Domain\Notification\Services\NotificationService;
use Carbon\Carbon;

/**
 * –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
 */
class BookingNotificationService
{
    public function __construct(
        private NotificationService $notificationService
    ) {}

    /**
     * –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    public function sendCreatedNotification(Booking $booking): void
    {
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
        $this->notificationService->send(
            $booking->user,
            'booking.created',
            [
                'booking_number' => $booking->number,
                'master_name' => $booking->master->name,
                'date' => $booking->start_at->format('d.m.Y'),
                'time' => $booking->start_at->format('H:i'),
                'service' => $booking->service->name,
            ]
        );

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä—É
        $this->notificationService->send(
            $booking->master->user,
            'booking.new_for_master',
            [
                'client_name' => $booking->user->name,
                'date' => $booking->start_at->format('d.m.Y'),
                'time' => $booking->start_at->format('H:i'),
                'service' => $booking->service->name,
            ]
        );
    }

    /**
     * –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
     */
    public function sendReminderNotification(Booking $booking): void
    {
        $hoursBeforeStart = Carbon::now()->diffInHours($booking->start_at, false);
        
        // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
        if ($hoursBeforeStart >= 23 && $hoursBeforeStart <= 25) {
            $this->notificationService->send(
                $booking->user,
                'booking.reminder_day_before',
                [
                    'master_name' => $booking->master->name,
                    'time' => $booking->start_at->format('H:i'),
                ]
            );
        }
        
        // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞
        if ($hoursBeforeStart >= 1.5 && $hoursBeforeStart <= 2.5) {
            $this->notificationService->send(
                $booking->user,
                'booking.reminder_2hours',
                [
                    'master_name' => $booking->master->name,
                    'address' => $booking->master->address,
                ]
            );
        }
    }

    /**
     * –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–Ω–æ—Å–µ
     */
    public function sendRescheduleNotification(Booking $booking, Carbon $oldDateTime): void
    {
        // –ö–ª–∏–µ–Ω—Ç—É
        $this->notificationService->send(
            $booking->user,
            'booking.rescheduled',
            [
                'old_date' => $oldDateTime->format('d.m.Y H:i'),
                'new_date' => $booking->start_at->format('d.m.Y H:i'),
                'master_name' => $booking->master->name,
            ]
        );

        // –ú–∞—Å—Ç–µ—Ä—É
        $this->notificationService->send(
            $booking->master->user,
            'booking.rescheduled_for_master',
            [
                'client_name' => $booking->user->name,
                'old_date' => $oldDateTime->format('d.m.Y H:i'),
                'new_date' => $booking->start_at->format('d.m.Y H:i'),
            ]
        );
    }

    /**
     * –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
     */
    public function sendCancellationNotification(Booking $booking, string $reason = null): void
    {
        // –ö–ª–∏–µ–Ω—Ç—É
        $this->notificationService->send(
            $booking->user,
            'booking.cancelled',
            [
                'booking_number' => $booking->number,
                'reason' => $reason,
                'refund_amount' => $booking->calculateRefundAmount(),
            ]
        );

        // –ú–∞—Å—Ç–µ—Ä—É
        $this->notificationService->send(
            $booking->master->user,
            'booking.cancelled_for_master',
            [
                'client_name' => $booking->user->name,
                'date' => $booking->start_at->format('d.m.Y H:i'),
                'reason' => $reason,
            ]
        );
    }

    /**
     * –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
     */
    public function sendConfirmationNotification(Booking $booking): void
    {
        $this->notificationService->send(
            $booking->user,
            'booking.confirmed',
            [
                'booking_number' => $booking->number,
                'master_name' => $booking->master->name,
                'date' => $booking->start_at->format('d.m.Y'),
                'time' => $booking->start_at->format('H:i'),
            ]
        );
    }
}
```

### ‚è∞ 16:00-18:00 - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ (2 —á–∞—Å–∞)

#### –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–ª–æ—Ç–æ–≤:

```php
<?php
// app/Domain/Booking/Services/BookingSlotService.php

namespace App\Domain\Booking\Services;

use App\Domain\Master\Models\MasterProfile;
use App\Domain\Booking\Models\Booking;
use App\Domain\Booking\Models\BookingSlot;
use Carbon\Carbon;
use Carbon\CarbonPeriod;
use Illuminate\Support\Collection;

/**
 * –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ª–æ—Ç–∞–º–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é
 */
class BookingSlotService
{
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–ª–æ—Ç–∞
     */
    public function isSlotAvailable(int $masterId, Carbon $dateTime, int $duration = 60): bool
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è –º–∞—Å—Ç–µ—Ä–∞
        if (!$this->isMasterWorking($masterId, $dateTime)) {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Ç –ª–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —Å –¥—Ä—É–≥–∏–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
        $endTime = $dateTime->copy()->addMinutes($duration);
        
        $hasConflict = Booking::where('master_id', $masterId)
            ->whereIn('status', ['confirmed', 'pending'])
            ->where(function ($query) use ($dateTime, $endTime) {
                $query->whereBetween('start_at', [$dateTime, $endTime])
                    ->orWhereBetween('end_at', [$dateTime, $endTime])
                    ->orWhere(function ($q) use ($dateTime, $endTime) {
                        $q->where('start_at', '<=', $dateTime)
                          ->where('end_at', '>=', $endTime);
                    });
            })
            ->exists();

        return !$hasConflict;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ –¥–µ–Ω—å
     */
    public function getAvailableSlots(int $masterId, Carbon $date): Collection
    {
        $master = MasterProfile::findOrFail($masterId);
        $dayOfWeek = $date->dayOfWeek;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
        $schedule = $master->schedules()
            ->where('day_of_week', $dayOfWeek)
            ->first();
            
        if (!$schedule || !$schedule->is_working) {
            return collect();
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 30 –º–∏–Ω—É—Ç
        $slots = collect();
        $startTime = Carbon::parse($date->format('Y-m-d') . ' ' . $schedule->start_time);
        $endTime = Carbon::parse($date->format('Y-m-d') . ' ' . $schedule->end_time);
        
        $period = CarbonPeriod::create($startTime, '30 minutes', $endTime);
        
        foreach ($period as $slotTime) {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
            if ($slotTime->isPast()) {
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
            if ($this->isSlotAvailable($masterId, $slotTime)) {
                $slots->push([
                    'time' => $slotTime->format('H:i'),
                    'datetime' => $slotTime->toIso8601String(),
                    'available' => true,
                ]);
            }
        }

        return $slots;
    }

    /**
     * –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–∞
     */
    public function reserveSlot(int $masterId, Carbon $dateTime, int $duration, int $bookingId): BookingSlot
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
        if (!$this->isSlotAvailable($masterId, $dateTime, $duration)) {
            throw new \Exception('–°–ª–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
        }

        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ —Å–ª–æ—Ç–µ
        return BookingSlot::create([
            'booking_id' => $bookingId,
            'master_id' => $masterId,
            'start_at' => $dateTime,
            'end_at' => $dateTime->copy()->addMinutes($duration),
            'status' => 'reserved',
        ]);
    }

    /**
     * –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å–ª–æ—Ç–∞
     */
    public function releaseSlot(int $bookingId): void
    {
        BookingSlot::where('booking_id', $bookingId)
            ->update(['status' => 'released']);
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–Ω—è—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤
     */
    public function getBookedSlots(int $masterId, Carbon $date): Collection
    {
        return Booking::where('master_id', $masterId)
            ->whereDate('start_at', $date)
            ->whereIn('status', ['confirmed', 'pending'])
            ->get()
            ->map(function ($booking) {
                return [
                    'start' => $booking->start_at->format('H:i'),
                    'end' => $booking->end_at->format('H:i'),
                    'client' => $booking->user->name,
                    'service' => $booking->service->name,
                ];
            });
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–∞—Å—Ç–µ—Ä –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
     */
    private function isMasterWorking(int $masterId, Carbon $dateTime): bool
    {
        $master = MasterProfile::find($masterId);
        if (!$master) {
            return false;
        }

        $dayOfWeek = $dateTime->dayOfWeek;
        $time = $dateTime->format('H:i:s');
        
        $schedule = $master->schedules()
            ->where('day_of_week', $dayOfWeek)
            ->where('is_working', true)
            ->where('start_time', '<=', $time)
            ->where('end_time', '>=', $time)
            ->first();
            
        return $schedule !== null;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
     */
    public function getNextAvailableSlot(int $masterId, Carbon $fromDate = null): ?array
    {
        $fromDate = $fromDate ?? Carbon::now();
        
        // –ò—â–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö 30 –¥–Ω–µ–π
        for ($i = 0; $i < 30; $i++) {
            $date = $fromDate->copy()->addDays($i);
            $slots = $this->getAvailableSlots($masterId, $date);
            
            if ($slots->isNotEmpty()) {
                return [
                    'date' => $date->format('Y-m-d'),
                    'time' => $slots->first()['time'],
                    'datetime' => $slots->first()['datetime'],
                ];
            }
        }
        
        return null;
    }
}
```

### ‚è∞ 18:00-19:00 - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫–∞ (1 —á–∞—Å)

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```powershell
# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
cd C:\www.spa.com
C:\Users\user1\.config\herd\bin\php.bat artisan test tests/Unit/Domain/Booking/

# –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
$oldFiles = @(
    "BookingValidator.php",
    "ValidationService.php",
    "CancellationValidationService.php",
    "BookingCompletionValidationService.php",
    "RescheduleValidator.php",
    "NotificationService.php",
    "BookingReminderService.php",
    "RescheduleNotificationHandler.php",
    "AvailabilityChecker.php",
    "AvailabilityService.php",
    "SlotService.php"
)

foreach ($file in $oldFiles) {
    $path = "C:\www.spa.com\app\Domain\Booking\Services\$file"
    if (Test-Path $path) {
        Remove-Item $path -Force
        Write-Host "–£–¥–∞–ª–µ–Ω: $file" -ForegroundColor Green
    }
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å
Get-ChildItem C:\www.spa.com\app\Domain\Booking\Services\*.php | Select-Object Name
```

#### –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```powershell
git add -A
git commit -m "refactor(booking): eliminate service duplication

- –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã 5 –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ –≤ BookingValidationService
- –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã 4 —Å–µ—Ä–≤–∏—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ BookingNotificationService  
- –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã 4 —Å–µ—Ä–≤–∏—Å–∞ —Å–ª–æ—Ç–æ–≤ –≤ BookingSlotService
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å 26 –¥–æ 7 —Å–µ—Ä–≤–∏—Å–æ–≤ (-73%)

BREAKING CHANGE: –ò–∑–º–µ–Ω–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ BookingService"
```

---

## üîß –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù: –î–ï–ù–¨ 2 - PAYMENT

### ‚è∞ 09:00-12:00 - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (3 —á–∞—Å–∞)

[–î–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è Payment –¥–æ–º–µ–Ω–∞...]

---

## üîß –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù: –î–ï–ù–¨ 3 - SEARCH

### ‚è∞ 09:00-12:00 - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ handlers (3 —á–∞—Å–∞)

[–î–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è Search –¥–æ–º–µ–Ω–∞...]

---

## ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –ß–ï–ö-–õ–ò–°–¢

### –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –ø—Ä–æ–≤–µ—Ä—è–µ–º:

- [ ] –í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Feature —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- [ ] DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –≤ AppServiceProvider
- [ ] –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã
- [ ] –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```powershell
# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
C:\Users\user1\.config\herd\bin\php.bat artisan test --testsuite=Unit
C:\Users\user1\.config\herd\bin\php.bat artisan test --testsuite=Feature

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
C:\Users\user1\.config\herd\bin\php.bat artisan test --coverage

# –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
C:\Users\user1\.config\herd\bin\php.bat artisan optimize:clear

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏
C:\Users\user1\.config\herd\bin\composer.bat dump-autoload
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ/–ø–æ—Å–ª–µ:

| –î–æ–º–µ–Ω | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ |
|-------|------|-------|------------|
| Booking | 26 | 7 | -73% |
| Payment | 30 | 9 | -70% |
| Search | 20 | 7 | -65% |
| **–ò–¢–û–ì–û** | **76** | **23** | **-70%** |

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏** - –≤ 3 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ —Ñ–∞–π–ª–æ–≤
2. **–Ø—Å–Ω–æ—Å—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã** - –ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
3. **–ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è** - –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –∫–æ–¥
4. **–°–Ω–∏–∂–µ–Ω–∏–µ –±–∞–≥–æ–≤** - –Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏
5. **–£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** - +200% –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏

### –†–∏—Å–∫–∏ –∏ –∏—Ö –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è:

| –†–∏—Å–∫ | –†–µ—à–µ–Ω–∏–µ |
|------|---------|
| –ü–æ–ª–æ–º–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ |
| –ü–æ—Ç–µ—Ä—è –∫–æ–¥–∞ | –ë—ç–∫–∞–ø—ã –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º |
| –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ git | –†–∞–±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–µ—Ç–∫–µ |
| –ü—Ä–æ–±–ª–µ–º—ã —Å DI | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AppServiceProvider |

---

## üöÄ –ö–û–ú–ê–ù–î–ê –î–õ–Ø –°–¢–ê–†–¢–ê

```powershell
# –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥!
cd C:\www.spa.com
git checkout -b refactor/service-deduplication
Write-Host "üöÄ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—á–∞—Ç! –°–ª–µ–¥—É–π—Ç–µ –ø–ª–∞–Ω—É –¥–µ–Ω—å –∑–∞ –¥–Ω–µ–º." -ForegroundColor Green
```

---

*–ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–±—â–µ–º—É –ø–ª–∞–Ω—É —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏–∑ complete-refactoring-plan.md (–¥–Ω–∏ 7-9)*