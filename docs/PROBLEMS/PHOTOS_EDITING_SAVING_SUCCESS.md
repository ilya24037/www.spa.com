# üéâ –£–°–ü–ï–®–ù–û–ï –†–ï–®–ï–ù–ò–ï: –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è

## üìã –ü–†–û–ë–õ–ï–ú–ê
–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π, —Ö–æ—Ç—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è**: `UpdateAdRequest` –æ–∂–∏–¥–∞–ª `photos.*` –∫–∞–∫ –º–∞—Å—Å–∏–≤—ã, –Ω–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–ª —Å—Ç—Ä–æ–∫–∏
2. **CSP –æ—à–∏–±–∫–∏**: `ImageCacheService` –ø—ã—Ç–∞–ª—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å base64 —á–µ—Ä–µ–∑ `fetch()`, —á—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ—Å—å Content Security Policy
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ**: `AdController::update` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ `DraftService`
4. **–î–≤–æ–π–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: `DraftService` –ø—ã—Ç–∞–ª—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–∞–∫ JSON

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
**–§–∞–π–ª—ã**: `CreateAdRequest.php`, `UpdateAdRequest.php`
```php
// –ë—ã–ª–æ
'photos.*' => 'nullable|array',

// –°—Ç–∞–ª–æ
'photos.*' => 'nullable',

// –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ withValidator()
if ($photo instanceof \Illuminate\Http\UploadedFile) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
} elseif (is_string($photo)) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ base64 –∏ URL
} elseif (is_array($photo)) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
}
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CSP
**–§–∞–π–ª**: `ImageCacheService.ts`
```typescript
async getImage(url: string): Promise<string> {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL base64 –¥–∞–Ω–Ω—ã–º–∏
    if (url.startsWith('data:image/')) {
        // –î–ª—è base64 –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º URL –∫–∞–∫ –µ—Å—Ç—å
        return url
    }
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö URL
}
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
**–§–∞–π–ª**: `AdController.php`
```php
public function update(UpdateAdRequest $request, Ad $ad): RedirectResponse
{
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ DraftService
    $processedPhotos = $this->processPhotosFromRequest($request);
    
    $data = array_merge(
        $request->validated(),
        ['photos' => $processedPhotos] // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    );
    
    $updatedAd = $this->draftService->saveOrUpdate($data, Auth::user(), $ad->id);
}
```

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
**–§–∞–π–ª**: `DraftService.php`
```php
// –ò–°–ö–õ–Æ–ß–ê–ï–ú photos - –æ–Ω–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ AdController
$jsonFields = ['clients', 'service_provider', 'features', 'services', 'schedule',
               'geo', 'custom_travel_areas', 'video', 'prices', 'faq'];

// –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è photos
if (isset($data['photos']) && is_array($data['photos'])) {
    // –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ AdController::processPhotosFromRequest
    Log::info('photos —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã', [
        'photos_count' => count($data['photos']),
        'photos_sample' => array_slice($data['photos'], 0, 2)
    ]);
}
```

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢
- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π** —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π** —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π**: —Ñ–∞–π–ª—ã, base64, URL
- ‚úÖ **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π** –±–µ–∑ CSP –æ—à–∏–±–æ–∫
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è** –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö

## üìö –£–†–û–ö–ò
1. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**: CreateAdRequest –∏ UpdateAdRequest –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
2. **CSP —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: base64 –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —á–µ—Ä–µ–∑ fetch()
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ —Å–µ—Ä–≤–∏—Å
4. **–ò–∑–±–µ–∂–∞–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏**: –∏—Å–∫–ª—é—á–∞—Ç—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø–æ–ª—è –∏–∑ JSON –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üèÜ –°–¢–ê–¢–£–°
**–ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–û** - –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
